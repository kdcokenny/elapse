{
	"date": "2024-10-17",
	"commits": [
		{
			"sha": "25cac220d6b6576e50ec52cf87801ad036fa7bc9",
			"message": "[ci] Allow passing various params to compiler publish script (#31283)\n\nAllow passing in a few more inputs when manually publishing.",
			"user": "poteto",
			"timestamp": "2024-10-17T22:12:58Z",
			"author": {
				"name": "lauren",
				"email": "poteto@users.noreply.github.com",
				"username": "poteto"
			},
			"files": {
				"added": [],
				"modified": [
					".github/workflows/compiler_prereleases.yml",
					".github/workflows/compiler_prereleases_manual.yml",
					".github/workflows/compiler_prereleases_nightly.yml"
				],
				"removed": []
			},
			"diff": "diff --git a/.github/workflows/compiler_prereleases.yml b/.github/workflows/compiler_prereleases.yml\nindex 9da6fc1b08e..4f4954dd952 100644\n--- a/.github/workflows/compiler_prereleases.yml\n+++ b/.github/workflows/compiler_prereleases.yml\n@@ -13,6 +13,9 @@ on:\n       dist_tag:\n         required: true\n         type: string\n+      version_name:\n+        required: true\n+        type: string\n     secrets:\n       NPM_TOKEN:\n         required: true\n@@ -49,4 +52,4 @@ jobs:\n       - name: Publish packages to npm\n         run: |\n           cp ./scripts/release/ci-npmrc ~/.npmrc\n-          scripts/release/publish.js --frfr --ci --versionName=0.0.0 --tag ${{ inputs.dist_tag }}\n+          scripts/release/publish.js --frfr --ci --versionName=${{ inputs.version_name }} --tag ${{ inputs.dist_tag }}\ndiff --git a/.github/workflows/compiler_prereleases_manual.yml b/.github/workflows/compiler_prereleases_manual.yml\nindex 87de411ddcb..3e42ae2cf20 100644\n--- a/.github/workflows/compiler_prereleases_manual.yml\n+++ b/.github/workflows/compiler_prereleases_manual.yml\n@@ -5,6 +5,15 @@ on:\n     inputs:\n       prerelease_commit_sha:\n         required: false\n+      release_channel:\n+        required: true\n+        type: string\n+      dist_tag:\n+        required: true\n+        type: string\n+      version_name:\n+        required: true\n+        type: string\n \n env:\n   TZ: /usr/share/zoneinfo/America/Los_Angeles\n@@ -15,7 +24,8 @@ jobs:\n     uses: facebook/react/.github/workflows/compiler_prereleases.yml@main\n     with:\n       commit_sha: ${{ inputs.prerelease_commit_sha || github.sha }}\n-      release_channel: experimental\n-      dist_tag: experimental\n+      release_channel: ${{ inputs.release_channel }}\n+      dist_tag: ${{ inputs.dist_tag }}\n+      version_name: ${{ inputs.version_name }}\n     secrets:\n       NPM_TOKEN: ${{ secrets.NPM_TOKEN }}\ndiff --git a/.github/workflows/compiler_prereleases_nightly.yml b/.github/workflows/compiler_prereleases_nightly.yml\nindex 90aafac4f63..82f893aa5ef 100644\n--- a/.github/workflows/compiler_prereleases_nightly.yml\n+++ b/.github/workflows/compiler_prereleases_nightly.yml\n@@ -16,5 +16,6 @@ jobs:\n       commit_sha: ${{ github.sha }}\n       release_channel: experimental\n       dist_tag: experimental\n+      version_name: '0.0.0'\n     secrets:\n       NPM_TOKEN: ${{ secrets.NPM_TOKEN }}\n",
			"diffSize": 2329,
			"diffTruncated": false,
			"filterResult": {
				"included": true
			},
			"associatedPR": {
				"number": 31283,
				"title": "[ci] Allow passing various params to compiler publish script",
				"state": "closed",
				"draft": false,
				"merged": true,
				"branch": "pr31283",
				"baseBranch": "main",
				"author": "poteto",
				"body": "\nAllow passing in a few more inputs when manually publishing.\n",
				"labels": ["CLA Signed", "React Core Team"],
				"requestedReviewers": [],
				"reviews": [],
				"comments": [
					{
						"id": 2420665667,
						"body": "[vc]: #NA4aaK2nMCSdYpYGAMsUb0SOqm7Fb5cNNfd2fps7zTw=:eyJpc01vbm9yZXBvIjp0cnVlLCJ0eXBlIjoiZ2l0aHViIiwicHJvamVjdHMiOlt7Im5hbWUiOiJyZWFjdC1jb21waWxlci1wbGF5Z3JvdW5kIiwiaW5zcGVjdG9yVXJsIjoiaHR0cHM6Ly92ZXJjZWwuY29tL2Zib3BlbnNvdXJjZS9yZWFjdC1jb21waWxlci1wbGF5Z3JvdW5kL0RYU3FXaTFhbU5NQk1ueEpGNDM3Mk41R0tSRnMiLCJwcmV2aWV3VXJsIjoicmVhY3QtY29tcGlsZXItcGxheWdyb3VuZC1naXQtcHIzMTI4My1mYm9wZW5zb3VyY2UudmVyY2VsLmFwcCIsIm5leHRDb21taXRTdGF0dXMiOiJERVBMT1lFRCIsImxpdmVGZWVkYmFjayI6eyJyZXNvbHZlZCI6MCwidW5yZXNvbHZlZCI6MCwidG90YWwiOjAsImxpbmsiOiJyZWFjdC1jb21waWxlci1wbGF5Z3JvdW5kLWdpdC1wcjMxMjgzLWZib3BlbnNvdXJjZS52ZXJjZWwuYXBwIn0sInJvb3REaXJlY3RvcnkiOiJjb21waWxlci9hcHBzL3BsYXlncm91bmQifV19\n**The latest updates on your projects**. Learn more about [Vercel for Git â†—ï¸Ž](https://vercel.link/github-learn-more)\n\n| Name | Status | Preview | Comments | Updated (UTC) |\n| :--- | :----- | :------ | :------- | :------ |\n| **react-compiler-playground** | âœ… Ready ([Inspect](https://vercel.com/fbopensource/react-compiler-playground/DXSqWi1amNMBMnxJF4372N5GKRFs)) | [Visit Preview](https://vercel.live/open-feedback/react-compiler-playground-git-pr31283-fbopensource.vercel.app?via=pr-comment-visit-preview-link&passThrough=1) | ðŸ’¬ [**Add feedback**](https://vercel.live/open-feedback/react-compiler-playground-git-pr31283-fbopensource.vercel.app?via=pr-comment-feedback-link) | Oct 17, 2024 10:04pm |\n\n",
						"author": "vercel[bot]",
						"createdAt": "2024-10-17T21:50:55Z"
					},
					{
						"id": 2420671916,
						"body": "\n<!--\n  0 failure: \n  0 warning: \n  \n  1 markdown notices\n  DangerID: danger-id-stable;\n-->\n\n\n\n\nComparing: 9c60cbe3d1b95d531ddcd64e0a6730db640c934e...94bec9f131a7d67f77d9893af7e417df9e570b92\n\n## Critical size changes\n\nIncludes critical production bundles, as well as any change greater than 2%:\n\n\n  | Name | +/- | Base | Current | +/- gzip | Base gzip | Current gzip |\n  | ---- | --- | ---- | ------- | -------- | --------- | ------------ |\n| [oss-stable/react-dom/cjs/react-dom.production.js](https://react-builds.vercel.app/commits/94bec9f131a7d67f77d9893af7e417df9e570b92/files/oss-stable/react-dom/cjs/react-dom.production.js?compare=9c60cbe3d1b95d531ddcd64e0a6730db640c934e) | **=** | 6.68 kB | 6.68 kB | +0.05% | 1.82 kB | 1.82 kB\n| [oss-stable/react-dom/cjs/react-dom-client.production.js](https://react-builds.vercel.app/commits/94bec9f131a7d67f77d9893af7e417df9e570b92/files/oss-stable/react-dom/cjs/react-dom-client.production.js?compare=9c60cbe3d1b95d531ddcd64e0a6730db640c934e) | **=** | 506.53 kB | 506.53 kB | = | 90.68 kB | 90.68 kB\n| [oss-experimental/react-dom/cjs/react-dom.production.js](https://react-builds.vercel.app/commits/94bec9f131a7d67f77d9893af7e417df9e570b92/files/oss-experimental/react-dom/cjs/react-dom.production.js?compare=9c60cbe3d1b95d531ddcd64e0a6730db640c934e) | **=** | 6.69 kB | 6.69 kB | = | 1.83 kB | 1.83 kB\n| [oss-experimental/react-dom/cjs/react-dom-client.production.js](https://react-builds.vercel.app/commits/94bec9f131a7d67f77d9893af7e417df9e570b92/files/oss-experimental/react-dom/cjs/react-dom-client.production.js?compare=9c60cbe3d1b95d531ddcd64e0a6730db640c934e) | **=** | 511.47 kB | 511.47 kB | = | 91.40 kB | 91.40 kB\n| [facebook-www/ReactDOM-prod.classic.js](https://react-builds.vercel.app/commits/94bec9f131a7d67f77d9893af7e417df9e570b92/files/facebook-www/ReactDOM-prod.classic.js?compare=9c60cbe3d1b95d531ddcd64e0a6730db640c934e) | **=** | 603.93 kB | 603.93 kB | = | 106.88 kB | 106.88 kB\n| [facebook-www/ReactDOM-prod.modern.js](https://react-builds.vercel.app/commits/94bec9f131a7d67f77d9893af7e417df9e570b92/files/facebook-www/ReactDOM-prod.modern.js?compare=9c60cbe3d1b95d531ddcd64e0a6730db640c934e) | **=** | 580.15 kB | 580.15 kB | = | 102.97 kB | 102.97 kB\n\n## Significant size changes\n\nIncludes any change greater than 0.2%:\n\n(No significant changes)\n\n<p align=\"right\">\n  Generated by :no_entry_sign: <a href=\"https://danger.systems/js\">dangerJS</a> against 053a210a0f5281a35b8e8dca72fc874bb2baf04a\n</p>\n",
						"author": "react-sizebot",
						"createdAt": "2024-10-17T21:56:19Z"
					}
				],
				"htmlUrl": "https://github.com/facebook/react/pull/31283"
			}
		},
		{
			"sha": "9c60cbe3d1b95d531ddcd64e0a6730db640c934e",
			"message": "[compiler] Clean up publish script (#31278)\n\nFew small tweaks to make it easier to run adhoc publishes\r\n---\r\n[//]: # (BEGIN SAPLING FOOTER)\r\nStack created with [Sapling](https://sapling-scm.com). Best reviewed\r\nwith [ReviewStack](https://reviewstack.dev/facebook/react/pull/31278).\r\n* #31283\r\n* __->__ #31278",
			"user": "poteto",
			"timestamp": "2024-10-17T22:02:41Z",
			"author": {
				"name": "lauren",
				"email": "poteto@users.noreply.github.com",
				"username": "poteto"
			},
			"files": {
				"added": [],
				"modified": [
					".github/workflows/compiler_prereleases.yml",
					"compiler/scripts/release/publish.js"
				],
				"removed": []
			},
			"diff": "diff --git a/.github/workflows/compiler_prereleases.yml b/.github/workflows/compiler_prereleases.yml\nindex c2b09dae054..9da6fc1b08e 100644\n--- a/.github/workflows/compiler_prereleases.yml\n+++ b/.github/workflows/compiler_prereleases.yml\n@@ -49,4 +49,4 @@ jobs:\n       - name: Publish packages to npm\n         run: |\n           cp ./scripts/release/ci-npmrc ~/.npmrc\n-          scripts/release/publish.js --frfr --ci --tags ${{ inputs.dist_tag }}\n+          scripts/release/publish.js --frfr --ci --versionName=0.0.0 --tag ${{ inputs.dist_tag }}\ndiff --git a/compiler/scripts/release/publish.js b/compiler/scripts/release/publish.js\nindex ef3b75a80fe..a7ad1a72546 100755\n--- a/compiler/scripts/release/publish.js\n+++ b/compiler/scripts/release/publish.js\n@@ -59,12 +59,19 @@ async function main() {\n       type: 'boolean',\n       default: false,\n     })\n-    .option('tags', {\n-      description: 'Tags to publish to npm',\n-      type: 'string',\n+    .option('tag', {\n+      description: 'Tag to publish to npm',\n+      type: 'choices',\n+      choices: ['experimental', 'beta'],\n       default: 'experimental',\n     })\n+    .option('version-name', {\n+      description: 'Version name',\n+      type: 'string',\n+      default: '0.0.0',\n+    })\n     .help('help')\n+    .strict()\n     .parseSync();\n \n   if (argv.debug === false) {\n@@ -82,7 +89,7 @@ async function main() {\n     pkgNames = [argv.packages];\n   }\n   const spinner = ora(\n-    `Preparing to publish ${\n+    `Preparing to publish ${argv.versionName}@${argv.tag} ${\n       argv.forReal === true ? '(for real)' : '(dry run)'\n     } [debug=${argv.debug}]`\n   ).info();\n@@ -118,14 +125,15 @@ async function main() {\n       }\n     );\n     const dateString = await getDateStringForCommit(commit);\n-    const otp = argv.ci === false ? await promptForOTP() : null;\n+    const otp =\n+      argv.ci === false && argv.debug === false ? await promptForOTP() : null;\n     const {hash} = await hashElement(path.resolve(__dirname, '../..'), {\n       encoding: 'hex',\n       folders: {exclude: ['node_modules']},\n       files: {exclude: ['.DS_Store']},\n     });\n     const truncatedHash = hash.slice(0, 7);\n-    const newVersion = `0.0.0-experimental-${truncatedHash}-${dateString}`;\n+    const newVersion = `${argv.versionName}-${argv.tag}-${truncatedHash}-${dateString}`;\n \n     for (const pkgName of pkgNames) {\n       const pkgDir = path.resolve(__dirname, `../../packages/${pkgName}`);\n@@ -179,29 +187,27 @@ async function main() {\n       spinner.succeed(`Successfully published ${pkgName} to npm`);\n \n       spinner.start('Pushing tags to npm');\n-      if (typeof argv.tags === 'string') {\n-        for (const tag of argv.tags.split(',')) {\n-          try {\n-            let opts = ['dist-tag', 'add', `${pkgName}@${newVersion}`, tag];\n-            if (otp != null) {\n-              opts.push(`--otp=${otp}`);\n-            }\n-            if (argv.debug === true) {\n-              spinner.info(`dry-run: npm ${opts.join(' ')}`);\n-            } else {\n-              await spawnHelper('npm', opts, {\n-                cwd: pkgDir,\n-                stdio: 'inherit',\n-              });\n-            }\n-          } catch (e) {\n-            spinner.fail(e.toString());\n-            throw e;\n+      if (typeof argv.tag === 'string') {\n+        try {\n+          let opts = ['dist-tag', 'add', `${pkgName}@${newVersion}`, argv.tag];\n+          if (otp != null) {\n+            opts.push(`--otp=${otp}`);\n           }\n-          spinner.succeed(\n-            `Successfully pushed dist-tag ${tag} for ${pkgName} to npm`\n-          );\n+          if (argv.debug === true) {\n+            spinner.info(`dry-run: npm ${opts.join(' ')}`);\n+          } else {\n+            await spawnHelper('npm', opts, {\n+              cwd: pkgDir,\n+              stdio: 'inherit',\n+            });\n+          }\n+        } catch (e) {\n+          spinner.fail(e.toString());\n+          throw e;\n         }\n+        spinner.succeed(\n+          `Successfully pushed dist-tag ${argv.tag} for ${pkgName} to npm`\n+        );\n       }\n     }\n \n",
			"diffSize": 4051,
			"diffTruncated": false,
			"filterResult": {
				"included": true
			},
			"associatedPR": {
				"number": 31278,
				"title": "[compiler] Clean up publish script",
				"state": "closed",
				"draft": false,
				"merged": true,
				"branch": "pr31278",
				"baseBranch": "main",
				"author": "poteto",
				"body": "\nFew small tweaks to make it easier to run adhoc publishes\n---\n[//]: # (BEGIN SAPLING FOOTER)\nStack created with [Sapling](https://sapling-scm.com). Best reviewed with [ReviewStack](https://reviewstack.dev/facebook/react/pull/31278).\n* #31283\n* __->__ #31278",
				"labels": ["CLA Signed", "React Core Team"],
				"requestedReviewers": [],
				"reviews": [
					{
						"id": 2375902786,
						"state": "APPROVED",
						"author": "josephsavona"
					}
				],
				"comments": [
					{
						"id": 2417949482,
						"body": "[vc]: #pFkho4zYbPnvLyf8uS4kejdZzrB00jxTQi+BBkmsbow=:eyJpc01vbm9yZXBvIjp0cnVlLCJ0eXBlIjoiZ2l0aHViIiwicHJvamVjdHMiOlt7Im5hbWUiOiJyZWFjdC1jb21waWxlci1wbGF5Z3JvdW5kIiwiaW5zcGVjdG9yVXJsIjoiaHR0cHM6Ly92ZXJjZWwuY29tL2Zib3BlbnNvdXJjZS9yZWFjdC1jb21waWxlci1wbGF5Z3JvdW5kLzRSb1NKNHVKTEx6aFpYcXl4ZmF3amlyVWlUSnciLCJwcmV2aWV3VXJsIjoicmVhY3QtY29tcGlsZXItcGxheWdyb3VuZC1naXQtcHIzMTI3OC1mYm9wZW5zb3VyY2UudmVyY2VsLmFwcCIsIm5leHRDb21taXRTdGF0dXMiOiJERVBMT1lFRCIsImxpdmVGZWVkYmFjayI6eyJyZXNvbHZlZCI6MCwidW5yZXNvbHZlZCI6MCwidG90YWwiOjAsImxpbmsiOiJyZWFjdC1jb21waWxlci1wbGF5Z3JvdW5kLWdpdC1wcjMxMjc4LWZib3BlbnNvdXJjZS52ZXJjZWwuYXBwIn0sInJvb3REaXJlY3RvcnkiOiJjb21waWxlci9hcHBzL3BsYXlncm91bmQifV19\n**The latest updates on your projects**. Learn more about [Vercel for Git â†—ï¸Ž](https://vercel.link/github-learn-more)\n\n| Name | Status | Preview | Comments | Updated (UTC) |\n| :--- | :----- | :------ | :------- | :------ |\n| **react-compiler-playground** | âœ… Ready ([Inspect](https://vercel.com/fbopensource/react-compiler-playground/4RoSJ4uJLLzhZXqyxfawjirUiTJw)) | [Visit Preview](https://vercel.live/open-feedback/react-compiler-playground-git-pr31278-fbopensource.vercel.app?via=pr-comment-visit-preview-link&passThrough=1) | ðŸ’¬ [**Add feedback**](https://vercel.live/open-feedback/react-compiler-playground-git-pr31278-fbopensource.vercel.app?via=pr-comment-feedback-link) | Oct 17, 2024 10:02pm |\n\n",
						"author": "vercel[bot]",
						"createdAt": "2024-10-16T20:57:18Z"
					},
					{
						"id": 2420679218,
						"body": "\n<!--\n  0 failure: \n  0 warning: \n  \n  1 markdown notices\n  DangerID: danger-id-stable;\n-->\n\n\n\n\nComparing: c91b3b090ad406fcd103483de0abb6adf44b6f48...278e071f2dec1a2419924ff9038bcfda9caf6920\n\n## Critical size changes\n\nIncludes critical production bundles, as well as any change greater than 2%:\n\n\n  | Name | +/- | Base | Current | +/- gzip | Base gzip | Current gzip |\n  | ---- | --- | ---- | ------- | -------- | --------- | ------------ |\n| [oss-stable/react-dom/cjs/react-dom.production.js](https://react-builds.vercel.app/commits/278e071f2dec1a2419924ff9038bcfda9caf6920/files/oss-stable/react-dom/cjs/react-dom.production.js?compare=c91b3b090ad406fcd103483de0abb6adf44b6f48) | **=** | 6.68 kB | 6.68 kB | = | 1.82 kB | 1.82 kB\n| [oss-stable/react-dom/cjs/react-dom-client.production.js](https://react-builds.vercel.app/commits/278e071f2dec1a2419924ff9038bcfda9caf6920/files/oss-stable/react-dom/cjs/react-dom-client.production.js?compare=c91b3b090ad406fcd103483de0abb6adf44b6f48) | **=** | 506.53 kB | 506.53 kB | = | 90.68 kB | 90.68 kB\n| [oss-experimental/react-dom/cjs/react-dom.production.js](https://react-builds.vercel.app/commits/278e071f2dec1a2419924ff9038bcfda9caf6920/files/oss-experimental/react-dom/cjs/react-dom.production.js?compare=c91b3b090ad406fcd103483de0abb6adf44b6f48) | **=** | 6.69 kB | 6.69 kB | +0.05% | 1.83 kB | 1.83 kB\n| [oss-experimental/react-dom/cjs/react-dom-client.production.js](https://react-builds.vercel.app/commits/278e071f2dec1a2419924ff9038bcfda9caf6920/files/oss-experimental/react-dom/cjs/react-dom-client.production.js?compare=c91b3b090ad406fcd103483de0abb6adf44b6f48) | **=** | 511.47 kB | 511.47 kB | = | 91.40 kB | 91.40 kB\n| [facebook-www/ReactDOM-prod.classic.js](https://react-builds.vercel.app/commits/278e071f2dec1a2419924ff9038bcfda9caf6920/files/facebook-www/ReactDOM-prod.classic.js?compare=c91b3b090ad406fcd103483de0abb6adf44b6f48) | **=** | 603.93 kB | 603.93 kB | = | 106.89 kB | 106.89 kB\n| [facebook-www/ReactDOM-prod.modern.js](https://react-builds.vercel.app/commits/278e071f2dec1a2419924ff9038bcfda9caf6920/files/facebook-www/ReactDOM-prod.modern.js?compare=c91b3b090ad406fcd103483de0abb6adf44b6f48) | **=** | 580.15 kB | 580.15 kB | = | 102.97 kB | 102.97 kB\n\n## Significant size changes\n\nIncludes any change greater than 0.2%:\n\n(No significant changes)\n\n<p align=\"right\">\n  Generated by :no_entry_sign: <a href=\"https://danger.systems/js\">dangerJS</a> against b4f6f8eebd804c8f44194010c897b9c8be71755a\n</p>\n",
						"author": "react-sizebot",
						"createdAt": "2024-10-17T22:02:41Z"
					}
				],
				"htmlUrl": "https://github.com/facebook/react/pull/31278"
			}
		},
		{
			"sha": "c91b3b090ad406fcd103483de0abb6adf44b6f48",
			"message": "JSX Outlining (#30956)\n\nCurrently, the react compiler can not compile within callbacks which can\r\npotentially cause over rendering. Consider this example:\r\n```jsx\r\nfunction Component(countries, onDelete) {\r\n  const name = useFoo();\r\n  return countries.map(() => {\r\n    return (\r\n      <Foo>\r\n        <Bar name={name}/>\r\n        <Baz onclick={onDelete} />\r\n      </Foo>\r\n    );\r\n  });\r\n}\r\n```\r\n\r\nIn this case, there's no memoization of the nested jsx elements. But\r\ninstead if we were to manually refactor the nested jsx into separate\r\ncomponent like this:\r\n```jsx\r\nfunction Component(countries, onDelete) {\r\n  const name = useFoo();\r\n  return countries.map(() => {\r\n    return <Temp name={name} onDelete={onDelete} />;\r\n  });\r\n}\r\n\r\nfunction Temp({ name, onDelete }) {\r\n  return (\r\n    <Foo>\r\n      <Bar name={name} />\r\n      <Baz onclick={onDelete} />\r\n    </Foo>\r\n  );\r\n}\r\n\r\n```\r\n\r\nThe compiler can now optimise both these components:\r\n```jsx\r\nfunction Component(countries, onDelete) {\r\n  const $ = _c(4);\r\n  const name = useFoo();\r\n  let t0;\r\n  if ($[0] !== name || $[1] !== onDelete || $[2] !== countries) {\r\n    t0 = countries.map(() => <Temp name={name} onDelete={onDelete} />);\r\n    $[0] = name;\r\n    $[1] = onDelete;\r\n    $[2] = countries;\r\n    $[3] = t0;\r\n  } else {\r\n    t0 = $[3];\r\n  }\r\n  return t0;\r\n}\r\n\r\nfunction Temp(t0) {\r\n  const $ = _c(7);\r\n  const { name, onDelete } = t0;\r\n  let t1;\r\n  if ($[0] !== name) {\r\n    t1 = <Bar name={name} />;\r\n    $[0] = name;\r\n    $[1] = t1;\r\n  } else {\r\n    t1 = $[1];\r\n  }\r\n  let t2;\r\n  if ($[2] !== onDelete) {\r\n    t2 = <Baz onclick={onDelete} />;\r\n    $[2] = onDelete;\r\n    $[3] = t2;\r\n  } else {\r\n    t2 = $[3];\r\n  }\r\n  let t3;\r\n  if ($[4] !== t1 || $[5] !== t2) {\r\n    t3 = (\r\n      <Foo>\r\n        {t1}\r\n        {t2}\r\n      </Foo>\r\n    );\r\n    $[4] = t1;\r\n    $[5] = t2;\r\n    $[6] = t3;\r\n  } else {\r\n    t3 = $[6];\r\n  }\r\n  return t3;\r\n}\r\n```\r\n\r\nNow, when `countries` is updated by adding one single value, only the\r\nnewly added value is re-rendered and not the entire list. Rather than\r\nhaving to do this manually, this PR teaches the react compiler to do\r\nthis transformation.\r\n\r\nThis PR adds a new pass (`OutlineJsx`) to capture nested jsx statements\r\nand outline them in a separate component. This newly outlined component\r\ncan then by memoized by the compiler, giving us more fine grained\r\nrendering.",
			"user": "gsathya",
			"timestamp": "2024-10-17T17:15:32Z",
			"author": {
				"name": "Sathya Gunasekaran",
				"email": "gsathya.ceg@gmail.com",
				"username": "gsathya"
			},
			"files": {
				"added": [
					"compiler/packages/babel-plugin-react-compiler/src/Optimization/OutlineJsx.ts",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-child-stored-in-id.expect.md",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-child-stored-in-id.js",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-jsx-stored-in-id.expect.md",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-jsx-stored-in-id.js",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-separate-nested.expect.md",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-separate-nested.js",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-simple.expect.md",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-simple.js",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-children.expect.md",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-children.js",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-duplicate-prop.expect.md",
					"compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-duplicate-prop.js"
				],
				"modified": [
					"compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts",
					"compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Program.ts",
					"compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts",
					"compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts"
				],
				"removed": []
			},
			"diff": "diff --git a/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts b/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts\nindex 900e4f49084..7ae520a144c 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts\n@@ -103,6 +103,7 @@ import {lowerContextAccess} from '../Optimization/LowerContextAccess';\n import {validateNoSetStateInPassiveEffects} from '../Validation/ValidateNoSetStateInPassiveEffects';\n import {validateNoJSXInTryStatement} from '../Validation/ValidateNoJSXInTryStatement';\n import {propagateScopeDependenciesHIR} from '../HIR/PropagateScopeDependenciesHIR';\n+import {outlineJSX} from '../Optimization/OutlineJsx';\n \n export type CompilerPipelineValue =\n   | {kind: 'ast'; name: string; value: CodegenFunction}\n@@ -278,6 +279,10 @@ function* runWithEnvironment(\n     value: hir,\n   });\n \n+  if (env.config.enableJsxOutlining) {\n+    outlineJSX(hir);\n+  }\n+\n   if (env.config.enableFunctionOutlining) {\n     outlineFunctions(hir, fbtOperands);\n     yield log({kind: 'hir', name: 'OutlineFunctions', value: hir});\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Program.ts b/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Program.ts\nindex d60f86e7fa4..1b1a82db0b9 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Program.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Program.ts\n@@ -199,7 +199,7 @@ function insertNewOutlinedFunctionNode(\n   program: NodePath<t.Program>,\n   originalFn: BabelFn,\n   compiledFn: CodegenFunction,\n-): NodePath<t.Function> {\n+): BabelFn {\n   switch (originalFn.type) {\n     case 'FunctionDeclaration': {\n       return originalFn.insertAfter(\n@@ -491,18 +491,11 @@ export function compileProgram(\n       fn.skip();\n       ALREADY_COMPILED.add(fn.node);\n       if (outlined.type !== null) {\n-        CompilerError.throwTodo({\n-          reason: `Implement support for outlining React functions (components/hooks)`,\n-          loc: outlined.fn.loc,\n+        queue.push({\n+          kind: 'outlined',\n+          fn,\n+          fnType: outlined.type,\n         });\n-        /*\n-         * Above should be as simple as the following, but needs testing:\n-         * queue.push({\n-         *   kind: \"outlined\",\n-         *   fn,\n-         *   fnType: outlined.type,\n-         * });\n-         */\n       }\n     }\n     compiledFns.push({\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts b/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\nindex b7d2b645c5b..b85d9425cb7 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\n@@ -354,6 +354,54 @@ const EnvironmentConfigSchema = z.object({\n    */\n   enableFunctionOutlining: z.boolean().default(true),\n \n+  /**\n+   * If enabled, this will outline nested JSX into a separate component.\n+   *\n+   * This will enable the compiler to memoize the separate component, giving us\n+   * the same behavior as compiling _within_ the callback.\n+   *\n+   * ```\n+   * function Component(countries, onDelete) {\n+   *   const name = useFoo();\n+   *   return countries.map(() => {\n+   *     return (\n+   *       <Foo>\n+   *         <Bar>{name}</Bar>\n+   *         <Button onclick={onDelete}>delete</Button>\n+   *       </Foo>\n+   *     );\n+   *   });\n+   * }\n+   * ```\n+   *\n+   * will be transpiled to:\n+   *\n+   * ```\n+   * function Component(countries, onDelete) {\n+   *   const name = useFoo();\n+   *   return countries.map(() => {\n+   *     return (\n+   *       <Temp name={name} onDelete={onDelete} />\n+   *     );\n+   *   });\n+   * }\n+   *\n+   * function Temp({name, onDelete}) {\n+   *   return (\n+   *     <Foo>\n+   *       <Bar>{name}</Bar>\n+   *       <Button onclick={onDelete}>delete</Button>\n+   *     </Foo>\n+   *   );\n+   * }\n+   *\n+   * Both, `Component` and `Temp` will then be memoized by the compiler.\n+   *\n+   * With this change, when `countries` is updated by adding one single value,\n+   * only the newly added value is re-rendered and not the entire list.\n+   */\n+  enableJsxOutlining: z.boolean().default(false),\n+\n   /*\n    * Enables instrumentation codegen. This emits a dev-mode only call to an\n    * instrumentation function, for components and hooks that Forget compiles.\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts b/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\nindex e771b386b39..263ec4c2087 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\n@@ -920,15 +920,7 @@ export type InstructionValue =\n       type: Type;\n       loc: SourceLocation;\n     }\n-  | {\n-      kind: 'JsxExpression';\n-      tag: Place | BuiltinTag;\n-      props: Array<JsxAttribute>;\n-      children: Array<Place> | null; // null === no children\n-      loc: SourceLocation;\n-      openingLoc: SourceLocation;\n-      closingLoc: SourceLocation;\n-    }\n+  | JsxExpression\n   | {\n       kind: 'ObjectExpression';\n       properties: Array<ObjectProperty | SpreadPattern>;\n@@ -1074,6 +1066,16 @@ export type InstructionValue =\n       loc: SourceLocation;\n     };\n \n+export type JsxExpression = {\n+  kind: 'JsxExpression';\n+  tag: Place | BuiltinTag;\n+  props: Array<JsxAttribute>;\n+  children: Array<Place> | null; // null === no children\n+  loc: SourceLocation;\n+  openingLoc: SourceLocation;\n+  closingLoc: SourceLocation;\n+};\n+\n export type JsxAttribute =\n   | {kind: 'JsxSpreadAttribute'; argument: Place}\n   | {kind: 'JsxAttribute'; name: string; place: Place};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Optimization/OutlineJsx.ts b/compiler/packages/babel-plugin-react-compiler/src/Optimization/OutlineJsx.ts\nnew file mode 100644\nindex 00000000000..f10f97c425d\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Optimization/OutlineJsx.ts\n@@ -0,0 +1,466 @@\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ */\n+\n+import invariant from 'invariant';\n+import {Environment} from '../HIR';\n+import {\n+  BasicBlock,\n+  GeneratedSource,\n+  HIRFunction,\n+  IdentifierId,\n+  Instruction,\n+  InstructionId,\n+  InstructionKind,\n+  JsxAttribute,\n+  JsxExpression,\n+  LoadGlobal,\n+  makeBlockId,\n+  makeIdentifierName,\n+  makeInstructionId,\n+  makeType,\n+  ObjectProperty,\n+  Place,\n+  promoteTemporary,\n+  promoteTemporaryJsxTag,\n+} from '../HIR/HIR';\n+import {createTemporaryPlace} from '../HIR/HIRBuilder';\n+import {printIdentifier} from '../HIR/PrintHIR';\n+import {deadCodeElimination} from './DeadCodeElimination';\n+import {assertExhaustive} from '../Utils/utils';\n+\n+export function outlineJSX(fn: HIRFunction): void {\n+  const outlinedFns: Array<HIRFunction> = [];\n+  outlineJsxImpl(fn, outlinedFns);\n+\n+  for (const outlinedFn of outlinedFns) {\n+    fn.env.outlineFunction(outlinedFn, 'Component');\n+  }\n+}\n+\n+type JsxInstruction = Instruction & {value: JsxExpression};\n+type LoadGlobalInstruction = Instruction & {value: LoadGlobal};\n+type LoadGlobalMap = Map<IdentifierId, LoadGlobalInstruction>;\n+\n+type State = {\n+  jsx: Array<JsxInstruction>;\n+  children: Set<IdentifierId>;\n+};\n+\n+function outlineJsxImpl(\n+  fn: HIRFunction,\n+  outlinedFns: Array<HIRFunction>,\n+): void {\n+  const globals: LoadGlobalMap = new Map();\n+\n+  function processAndOutlineJSX(\n+    state: State,\n+    rewriteInstr: Map<InstructionId, Array<Instruction>>,\n+  ): void {\n+    if (state.jsx.length <= 1) {\n+      return;\n+    }\n+    const result = process(\n+      fn,\n+      [...state.jsx].sort((a, b) => a.id - b.id),\n+      globals,\n+    );\n+    if (result) {\n+      outlinedFns.push(result.fn);\n+      rewriteInstr.set(state.jsx.at(0)!.id, result.instrs);\n+    }\n+  }\n+\n+  for (const [, block] of fn.body.blocks) {\n+    const rewriteInstr = new Map();\n+    let state: State = {\n+      jsx: [],\n+      children: new Set(),\n+    };\n+\n+    for (let i = block.instructions.length - 1; i >= 0; i--) {\n+      const instr = block.instructions[i];\n+      const {value, lvalue} = instr;\n+      switch (value.kind) {\n+        case 'LoadGlobal': {\n+          globals.set(lvalue.identifier.id, instr as LoadGlobalInstruction);\n+          break;\n+        }\n+        case 'FunctionExpression': {\n+          outlineJsxImpl(value.loweredFunc.func, outlinedFns);\n+          break;\n+        }\n+\n+        case 'JsxExpression': {\n+          if (!state.children.has(lvalue.identifier.id)) {\n+            processAndOutlineJSX(state, rewriteInstr);\n+\n+            state = {\n+              jsx: [],\n+              children: new Set(),\n+            };\n+          }\n+          state.jsx.push(instr as JsxInstruction);\n+          if (value.children) {\n+            for (const child of value.children) {\n+              state.children.add(child.identifier.id);\n+            }\n+          }\n+          break;\n+        }\n+        case 'ArrayExpression':\n+        case 'Await':\n+        case 'BinaryExpression':\n+        case 'CallExpression':\n+        case 'ComputedDelete':\n+        case 'ComputedLoad':\n+        case 'ComputedStore':\n+        case 'Debugger':\n+        case 'DeclareContext':\n+        case 'DeclareLocal':\n+        case 'Destructure':\n+        case 'FinishMemoize':\n+        case 'GetIterator':\n+        case 'IteratorNext':\n+        case 'JSXText':\n+        case 'JsxFragment':\n+        case 'LoadContext':\n+        case 'LoadLocal':\n+        case 'MetaProperty':\n+        case 'MethodCall':\n+        case 'NewExpression':\n+        case 'NextPropertyOf':\n+        case 'ObjectExpression':\n+        case 'ObjectMethod':\n+        case 'PostfixUpdate':\n+        case 'PrefixUpdate':\n+        case 'Primitive':\n+        case 'PropertyDelete':\n+        case 'PropertyLoad':\n+        case 'PropertyStore':\n+        case 'RegExpLiteral':\n+        case 'StartMemoize':\n+        case 'StoreContext':\n+        case 'StoreGlobal':\n+        case 'StoreLocal':\n+        case 'TaggedTemplateExpression':\n+        case 'TemplateLiteral':\n+        case 'TypeCastExpression':\n+        case 'UnsupportedNode':\n+        case 'UnaryExpression': {\n+          break;\n+        }\n+        default: {\n+          assertExhaustive(value, `Unexpected instruction: ${value}`);\n+        }\n+      }\n+    }\n+    processAndOutlineJSX(state, rewriteInstr);\n+\n+    if (rewriteInstr.size > 0) {\n+      const newInstrs = [];\n+      for (let i = 0; i < block.instructions.length; i++) {\n+        // InstructionId's are one-indexed, so add one to account for them.\n+        const id = i + 1;\n+        if (rewriteInstr.has(id)) {\n+          const instrs = rewriteInstr.get(id);\n+          newInstrs.push(...instrs);\n+        } else {\n+          newInstrs.push(block.instructions[i]);\n+        }\n+      }\n+      block.instructions = newInstrs;\n+    }\n+    deadCodeElimination(fn);\n+  }\n+}\n+\n+type OutlinedResult = {\n+  instrs: Array<Instruction>;\n+  fn: HIRFunction;\n+};\n+\n+function process(\n+  fn: HIRFunction,\n+  jsx: Array<JsxInstruction>,\n+  globals: LoadGlobalMap,\n+): OutlinedResult | null {\n+  /**\n+   * In the future, add a check for backedge to outline jsx inside loops in a\n+   * top level component. For now, only outline jsx in callbacks.\n+   */\n+  if (fn.fnType === 'Component') {\n+    return null;\n+  }\n+\n+  const props = collectProps(jsx);\n+  if (!props) return null;\n+\n+  const outlinedTag = fn.env.generateGloballyUniqueIdentifierName(null).value;\n+  const newInstrs = emitOutlinedJsx(fn.env, jsx, props, outlinedTag);\n+  if (!newInstrs) return null;\n+\n+  const outlinedFn = emitOutlinedFn(fn.env, jsx, props, globals);\n+  if (!outlinedFn) return null;\n+  outlinedFn.id = outlinedTag;\n+\n+  return {instrs: newInstrs, fn: outlinedFn};\n+}\n+\n+function collectProps(\n+  instructions: Array<JsxInstruction>,\n+): Array<JsxAttribute> | null {\n+  const attributes: Array<JsxAttribute> = [];\n+  const jsxIds = new Set(instructions.map(i => i.lvalue.identifier.id));\n+  const seen: Set<string> = new Set();\n+  for (const instr of instructions) {\n+    const {value} = instr;\n+\n+    for (const at of value.props) {\n+      if (at.kind === 'JsxSpreadAttribute') {\n+        return null;\n+      }\n+\n+      /*\n+       * TODO(gsn): Handle attributes that have same value across\n+       * the outlined jsx instructions.\n+       */\n+      if (seen.has(at.name)) {\n+        return null;\n+      }\n+\n+      if (at.kind === 'JsxAttribute') {\n+        seen.add(at.name);\n+        attributes.push(at);\n+      }\n+    }\n+\n+    // TODO(gsn): Add support for children that are not jsx expressions\n+    if (\n+      value.children &&\n+      value.children.some(child => !jsxIds.has(child.identifier.id))\n+    ) {\n+      return null;\n+    }\n+  }\n+  return attributes;\n+}\n+\n+function emitOutlinedJsx(\n+  env: Environment,\n+  instructions: Array<Instruction>,\n+  props: Array<JsxAttribute>,\n+  outlinedTag: string,\n+): Array<Instruction> {\n+  const loadJsx: Instruction = {\n+    id: makeInstructionId(0),\n+    loc: GeneratedSource,\n+    lvalue: createTemporaryPlace(env, GeneratedSource),\n+    value: {\n+      kind: 'LoadGlobal',\n+      binding: {\n+        kind: 'ModuleLocal',\n+        name: outlinedTag,\n+      },\n+      loc: GeneratedSource,\n+    },\n+  };\n+  promoteTemporaryJsxTag(loadJsx.lvalue.identifier);\n+  const jsxExpr: Instruction = {\n+    id: makeInstructionId(0),\n+    loc: GeneratedSource,\n+    lvalue: instructions.at(-1)!.lvalue,\n+    value: {\n+      kind: 'JsxExpression',\n+      tag: {...loadJsx.lvalue},\n+      props,\n+      children: null,\n+      loc: GeneratedSource,\n+      openingLoc: GeneratedSource,\n+      closingLoc: GeneratedSource,\n+    },\n+  };\n+\n+  return [loadJsx, jsxExpr];\n+}\n+\n+function emitOutlinedFn(\n+  env: Environment,\n+  jsx: Array<JsxInstruction>,\n+  oldProps: Array<JsxAttribute>,\n+  globals: LoadGlobalMap,\n+): HIRFunction | null {\n+  const instructions: Array<Instruction> = [];\n+  const oldToNewProps = createOldToNewPropsMapping(env, oldProps);\n+\n+  const propsObj: Place = createTemporaryPlace(env, GeneratedSource);\n+  promoteTemporary(propsObj.identifier);\n+\n+  const destructurePropsInstr = emitDestructureProps(env, propsObj, [\n+    ...oldToNewProps.values(),\n+  ]);\n+  instructions.push(destructurePropsInstr);\n+\n+  const updatedJsxInstructions = emitUpdatedJsx(jsx, oldToNewProps);\n+  const loadGlobalInstrs = emitLoadGlobals(jsx, globals);\n+  if (!loadGlobalInstrs) {\n+    return null;\n+  }\n+  instructions.push(...loadGlobalInstrs);\n+  instructions.push(...updatedJsxInstructions);\n+\n+  const block: BasicBlock = {\n+    kind: 'block',\n+    id: makeBlockId(0),\n+    instructions,\n+    terminal: {\n+      id: makeInstructionId(0),\n+      kind: 'return',\n+      loc: GeneratedSource,\n+      value: instructions.at(-1)!.lvalue,\n+    },\n+    preds: new Set(),\n+    phis: new Set(),\n+  };\n+\n+  const fn: HIRFunction = {\n+    loc: GeneratedSource,\n+    id: null,\n+    fnType: 'Other',\n+    env,\n+    params: [propsObj],\n+    returnTypeAnnotation: null,\n+    returnType: makeType(),\n+    context: [],\n+    effects: null,\n+    body: {\n+      entry: block.id,\n+      blocks: new Map([[block.id, block]]),\n+    },\n+    generator: false,\n+    async: false,\n+    directives: [],\n+  };\n+  return fn;\n+}\n+\n+function emitLoadGlobals(\n+  jsx: Array<JsxInstruction>,\n+  globals: LoadGlobalMap,\n+): Array<Instruction> | null {\n+  const instructions: Array<Instruction> = [];\n+  for (const {value} of jsx) {\n+    // Add load globals instructions for jsx tags\n+    if (value.tag.kind === 'Identifier') {\n+      const loadGlobalInstr = globals.get(value.tag.identifier.id);\n+      if (!loadGlobalInstr) {\n+        return null;\n+      }\n+      instructions.push(loadGlobalInstr);\n+    }\n+  }\n+\n+  return instructions;\n+}\n+\n+function emitUpdatedJsx(\n+  jsx: Array<JsxInstruction>,\n+  oldToNewProps: Map<IdentifierId, ObjectProperty>,\n+): Array<JsxInstruction> {\n+  const newInstrs: Array<JsxInstruction> = [];\n+\n+  for (const instr of jsx) {\n+    const {value} = instr;\n+    const newProps: Array<JsxAttribute> = [];\n+    // Update old props references to use the newly destructured props param\n+    for (const prop of value.props) {\n+      invariant(\n+        prop.kind === 'JsxAttribute',\n+        `Expected only attributes but found ${prop.kind}`,\n+      );\n+      if (prop.name === 'key') {\n+        continue;\n+      }\n+      const newProp = oldToNewProps.get(prop.place.identifier.id);\n+      invariant(\n+        newProp !== undefined,\n+        `Expected a new property for ${printIdentifier(prop.place.identifier)}`,\n+      );\n+      newProps.push({\n+        ...prop,\n+        place: newProp.place,\n+      });\n+    }\n+\n+    newInstrs.push({\n+      ...instr,\n+      value: {\n+        ...value,\n+        props: newProps,\n+      },\n+    });\n+  }\n+\n+  return newInstrs;\n+}\n+\n+function createOldToNewPropsMapping(\n+  env: Environment,\n+  oldProps: Array<JsxAttribute>,\n+): Map<IdentifierId, ObjectProperty> {\n+  const oldToNewProps = new Map();\n+\n+  for (const oldProp of oldProps) {\n+    invariant(\n+      oldProp.kind === 'JsxAttribute',\n+      `Expected only attributes but found ${oldProp.kind}`,\n+    );\n+\n+    // Do not read key prop in the outlined component\n+    if (oldProp.name === 'key') {\n+      continue;\n+    }\n+\n+    const newProp: ObjectProperty = {\n+      kind: 'ObjectProperty',\n+      key: {\n+        kind: 'string',\n+        name: oldProp.name,\n+      },\n+      type: 'property',\n+      place: createTemporaryPlace(env, GeneratedSource),\n+    };\n+    newProp.place.identifier.name = makeIdentifierName(oldProp.name);\n+    oldToNewProps.set(oldProp.place.identifier.id, newProp);\n+  }\n+\n+  return oldToNewProps;\n+}\n+\n+function emitDestructureProps(\n+  env: Environment,\n+  propsObj: Place,\n+  properties: Array<ObjectProperty>,\n+): Instruction {\n+  const destructurePropsInstr: Instruction = {\n+    id: makeInstructionId(0),\n+    lvalue: createTemporaryPlace(env, GeneratedSource),\n+    loc: GeneratedSource,\n+    value: {\n+      kind: 'Destructure',\n+      lvalue: {\n+        pattern: {\n+          kind: 'ObjectPattern',\n+          properties,\n+        },\n+        kind: InstructionKind.Let,\n+      },\n+      loc: GeneratedSource,\n+      value: propsObj,\n+    },\n+  };\n+  return destructurePropsInstr;\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-child-stored-in-id.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-child-stored-in-id.expect.md\nnew file mode 100644\nindex 00000000000..fd7ca41bcff\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-child-stored-in-id.expect.md\n@@ -0,0 +1,143 @@\n+\n+## Input\n+\n+```javascript\n+// @enableJsxOutlining\n+function Component(arr) {\n+  const x = useX();\n+  return arr.map(i => {\n+    <>\n+      {arr.map((i, id) => {\n+        let child = (\n+          <Bar x={x}>\n+            <Baz i={i}></Baz>\n+          </Bar>\n+        );\n+\n+        let jsx = <div>{child}</div>;\n+        return jsx;\n+      })}\n+    </>;\n+  });\n+}\n+\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return <>{i}</>;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @enableJsxOutlining\n+function Component(arr) {\n+  const $ = _c(3);\n+  const x = useX();\n+  let t0;\n+  if ($[0] !== arr || $[1] !== x) {\n+    t0 = arr.map((i) => {\n+      arr.map((i_0, id) => {\n+        const T0 = _temp;\n+        const child = <T0 i={i_0} x={x} />;\n+\n+        const jsx = <div>{child}</div>;\n+        return jsx;\n+      });\n+    });\n+    $[0] = arr;\n+    $[1] = x;\n+    $[2] = t0;\n+  } else {\n+    t0 = $[2];\n+  }\n+  return t0;\n+}\n+function _temp(t0) {\n+  const $ = _c(5);\n+  const { i: i, x: x } = t0;\n+  let t1;\n+  if ($[0] !== i) {\n+    t1 = <Baz i={i} />;\n+    $[0] = i;\n+    $[1] = t1;\n+  } else {\n+    t1 = $[1];\n+  }\n+  let t2;\n+  if ($[2] !== x || $[3] !== t1) {\n+    t2 = <Bar x={x}>{t1}</Bar>;\n+    $[2] = x;\n+    $[3] = t1;\n+    $[4] = t2;\n+  } else {\n+    t2 = $[4];\n+  }\n+  return t2;\n+}\n+\n+function Bar(t0) {\n+  const $ = _c(3);\n+  const { x, children } = t0;\n+  let t1;\n+  if ($[0] !== x || $[1] !== children) {\n+    t1 = (\n+      <>\n+        {x}\n+        {children}\n+      </>\n+    );\n+    $[0] = x;\n+    $[1] = children;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  return t1;\n+}\n+\n+function Baz(t0) {\n+  const $ = _c(2);\n+  const { i } = t0;\n+  let t1;\n+  if ($[0] !== i) {\n+    t1 = <>{i}</>;\n+    $[0] = i;\n+    $[1] = t1;\n+  } else {\n+    t1 = $[1];\n+  }\n+  return t1;\n+}\n+\n+function useX() {\n+  return \"x\";\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{ arr: [\"foo\", \"bar\"] }],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: exception) arr.map is not a function\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-child-stored-in-id.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-child-stored-in-id.js\nnew file mode 100644\nindex 00000000000..b7a82cd2a4b\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-child-stored-in-id.js\n@@ -0,0 +1,40 @@\n+// @enableJsxOutlining\n+function Component(arr) {\n+  const x = useX();\n+  return arr.map(i => {\n+    <>\n+      {arr.map((i, id) => {\n+        let child = (\n+          <Bar x={x}>\n+            <Baz i={i}></Baz>\n+          </Bar>\n+        );\n+\n+        let jsx = <div>{child}</div>;\n+        return jsx;\n+      })}\n+    </>;\n+  });\n+}\n+\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return <>{i}</>;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-jsx-stored-in-id.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-jsx-stored-in-id.expect.md\nnew file mode 100644\nindex 00000000000..496282e1ef6\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-jsx-stored-in-id.expect.md\n@@ -0,0 +1,145 @@\n+\n+## Input\n+\n+```javascript\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        let jsx = (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}></Baz>\n+          </Bar>\n+        );\n+        return jsx;\n+      })}\n+    </>\n+  );\n+}\n+\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @enableJsxOutlining\n+function Component(t0) {\n+  const $ = _c(7);\n+  const { arr } = t0;\n+  const x = useX();\n+  let t1;\n+  if ($[0] !== x || $[1] !== arr) {\n+    let t2;\n+    if ($[3] !== x) {\n+      t2 = (i, id) => {\n+        const T0 = _temp;\n+        const jsx = <T0 i={i} key={id} x={x} />;\n+        return jsx;\n+      };\n+      $[3] = x;\n+      $[4] = t2;\n+    } else {\n+      t2 = $[4];\n+    }\n+    t1 = arr.map(t2);\n+    $[0] = x;\n+    $[1] = arr;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  let t2;\n+  if ($[5] !== t1) {\n+    t2 = <>{t1}</>;\n+    $[5] = t1;\n+    $[6] = t2;\n+  } else {\n+    t2 = $[6];\n+  }\n+  return t2;\n+}\n+function _temp(t0) {\n+  const $ = _c(5);\n+  const { i: i, x: x } = t0;\n+  let t1;\n+  if ($[0] !== i) {\n+    t1 = <Baz i={i} />;\n+    $[0] = i;\n+    $[1] = t1;\n+  } else {\n+    t1 = $[1];\n+  }\n+  let t2;\n+  if ($[2] !== x || $[3] !== t1) {\n+    t2 = <Bar x={x}>{t1}</Bar>;\n+    $[2] = x;\n+    $[3] = t1;\n+    $[4] = t2;\n+  } else {\n+    t2 = $[4];\n+  }\n+  return t2;\n+}\n+\n+function Bar(t0) {\n+  const $ = _c(3);\n+  const { x, children } = t0;\n+  let t1;\n+  if ($[0] !== x || $[1] !== children) {\n+    t1 = (\n+      <>\n+        {x}\n+        {children}\n+      </>\n+    );\n+    $[0] = x;\n+    $[1] = children;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  return t1;\n+}\n+\n+function Baz(t0) {\n+  const { i } = t0;\n+  return i;\n+}\n+\n+function useX() {\n+  return \"x\";\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{ arr: [\"foo\", \"bar\"] }],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) xfooxbar\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-jsx-stored-in-id.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-jsx-stored-in-id.js\nnew file mode 100644\nindex 00000000000..971a9ff9962\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-jsx-stored-in-id.js\n@@ -0,0 +1,38 @@\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        let jsx = (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}></Baz>\n+          </Bar>\n+        );\n+        return jsx;\n+      })}\n+    </>\n+  );\n+}\n+\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-separate-nested.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-separate-nested.expect.md\nnew file mode 100644\nindex 00000000000..7f86546cd4d\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-separate-nested.expect.md\n@@ -0,0 +1,186 @@\n+\n+## Input\n+\n+```javascript\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        return (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}></Baz>\n+            <Joe j={i}></Joe>\n+            <Foo k={i}></Foo>\n+          </Bar>\n+        );\n+      })}\n+    </>\n+  );\n+}\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function Joe({j}) {\n+  return j;\n+}\n+\n+function Foo({k}) {\n+  return k;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @enableJsxOutlining\n+function Component(t0) {\n+  const $ = _c(7);\n+  const { arr } = t0;\n+  const x = useX();\n+  let t1;\n+  if ($[0] !== x || $[1] !== arr) {\n+    let t2;\n+    if ($[3] !== x) {\n+      t2 = (i, id) => {\n+        const T0 = _temp;\n+        return <T0 i={i} j={i} k={i} key={id} x={x} />;\n+      };\n+      $[3] = x;\n+      $[4] = t2;\n+    } else {\n+      t2 = $[4];\n+    }\n+    t1 = arr.map(t2);\n+    $[0] = x;\n+    $[1] = arr;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  let t2;\n+  if ($[5] !== t1) {\n+    t2 = <>{t1}</>;\n+    $[5] = t1;\n+    $[6] = t2;\n+  } else {\n+    t2 = $[6];\n+  }\n+  return t2;\n+}\n+function _temp(t0) {\n+  const $ = _c(11);\n+  const { i: i, j: j, k: k, x: x } = t0;\n+  let t1;\n+  if ($[0] !== i) {\n+    t1 = <Baz i={i} />;\n+    $[0] = i;\n+    $[1] = t1;\n+  } else {\n+    t1 = $[1];\n+  }\n+  let t2;\n+  if ($[2] !== j) {\n+    t2 = <Joe j={j} />;\n+    $[2] = j;\n+    $[3] = t2;\n+  } else {\n+    t2 = $[3];\n+  }\n+  let t3;\n+  if ($[4] !== k) {\n+    t3 = <Foo k={k} />;\n+    $[4] = k;\n+    $[5] = t3;\n+  } else {\n+    t3 = $[5];\n+  }\n+  let t4;\n+  if ($[6] !== x || $[7] !== t1 || $[8] !== t2 || $[9] !== t3) {\n+    t4 = (\n+      <Bar x={x}>\n+        {t1}\n+        {t2}\n+        {t3}\n+      </Bar>\n+    );\n+    $[6] = x;\n+    $[7] = t1;\n+    $[8] = t2;\n+    $[9] = t3;\n+    $[10] = t4;\n+  } else {\n+    t4 = $[10];\n+  }\n+  return t4;\n+}\n+\n+function Bar(t0) {\n+  const $ = _c(3);\n+  const { x, children } = t0;\n+  let t1;\n+  if ($[0] !== x || $[1] !== children) {\n+    t1 = (\n+      <>\n+        {x}\n+        {children}\n+      </>\n+    );\n+    $[0] = x;\n+    $[1] = children;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  return t1;\n+}\n+\n+function Baz(t0) {\n+  const { i } = t0;\n+  return i;\n+}\n+\n+function Joe(t0) {\n+  const { j } = t0;\n+  return j;\n+}\n+\n+function Foo(t0) {\n+  const { k } = t0;\n+  return k;\n+}\n+\n+function useX() {\n+  return \"x\";\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{ arr: [\"foo\", \"bar\"] }],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) xfoofoofooxbarbarbar\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-separate-nested.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-separate-nested.js\nnew file mode 100644\nindex 00000000000..47d97cfc68f\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-separate-nested.js\n@@ -0,0 +1,46 @@\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        return (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}></Baz>\n+            <Joe j={i}></Joe>\n+            <Foo k={i}></Foo>\n+          </Bar>\n+        );\n+      })}\n+    </>\n+  );\n+}\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function Joe({j}) {\n+  return j;\n+}\n+\n+function Foo({k}) {\n+  return k;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-simple.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-simple.expect.md\nnew file mode 100644\nindex 00000000000..9e268227a23\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-simple.expect.md\n@@ -0,0 +1,142 @@\n+\n+## Input\n+\n+```javascript\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        return (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}></Baz>\n+          </Bar>\n+        );\n+      })}\n+    </>\n+  );\n+}\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @enableJsxOutlining\n+function Component(t0) {\n+  const $ = _c(7);\n+  const { arr } = t0;\n+  const x = useX();\n+  let t1;\n+  if ($[0] !== x || $[1] !== arr) {\n+    let t2;\n+    if ($[3] !== x) {\n+      t2 = (i, id) => {\n+        const T0 = _temp;\n+        return <T0 i={i} key={id} x={x} />;\n+      };\n+      $[3] = x;\n+      $[4] = t2;\n+    } else {\n+      t2 = $[4];\n+    }\n+    t1 = arr.map(t2);\n+    $[0] = x;\n+    $[1] = arr;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  let t2;\n+  if ($[5] !== t1) {\n+    t2 = <>{t1}</>;\n+    $[5] = t1;\n+    $[6] = t2;\n+  } else {\n+    t2 = $[6];\n+  }\n+  return t2;\n+}\n+function _temp(t0) {\n+  const $ = _c(5);\n+  const { i: i, x: x } = t0;\n+  let t1;\n+  if ($[0] !== i) {\n+    t1 = <Baz i={i} />;\n+    $[0] = i;\n+    $[1] = t1;\n+  } else {\n+    t1 = $[1];\n+  }\n+  let t2;\n+  if ($[2] !== x || $[3] !== t1) {\n+    t2 = <Bar x={x}>{t1}</Bar>;\n+    $[2] = x;\n+    $[3] = t1;\n+    $[4] = t2;\n+  } else {\n+    t2 = $[4];\n+  }\n+  return t2;\n+}\n+\n+function Bar(t0) {\n+  const $ = _c(3);\n+  const { x, children } = t0;\n+  let t1;\n+  if ($[0] !== x || $[1] !== children) {\n+    t1 = (\n+      <>\n+        {x}\n+        {children}\n+      </>\n+    );\n+    $[0] = x;\n+    $[1] = children;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  return t1;\n+}\n+\n+function Baz(t0) {\n+  const { i } = t0;\n+  return i;\n+}\n+\n+function useX() {\n+  return \"x\";\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{ arr: [\"foo\", \"bar\"] }],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) xfooxbar\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-simple.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-simple.js\nnew file mode 100644\nindex 00000000000..c4dcc86763b\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/jsx-outlining-simple.js\n@@ -0,0 +1,36 @@\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        return (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}></Baz>\n+          </Bar>\n+        );\n+      })}\n+    </>\n+  );\n+}\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-children.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-children.expect.md\nnew file mode 100644\nindex 00000000000..f106382d641\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-children.expect.md\n@@ -0,0 +1,121 @@\n+\n+## Input\n+\n+```javascript\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        return (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}>Test</Baz>\n+          </Bar>\n+        );\n+      })}\n+    </>\n+  );\n+}\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @enableJsxOutlining\n+function Component(t0) {\n+  const $ = _c(7);\n+  const { arr } = t0;\n+  const x = useX();\n+  let t1;\n+  if ($[0] !== x || $[1] !== arr) {\n+    let t2;\n+    if ($[3] !== x) {\n+      t2 = (i, id) => (\n+        <Bar key={id} x={x}>\n+          <Baz i={i}>Test</Baz>\n+        </Bar>\n+      );\n+      $[3] = x;\n+      $[4] = t2;\n+    } else {\n+      t2 = $[4];\n+    }\n+    t1 = arr.map(t2);\n+    $[0] = x;\n+    $[1] = arr;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  let t2;\n+  if ($[5] !== t1) {\n+    t2 = <>{t1}</>;\n+    $[5] = t1;\n+    $[6] = t2;\n+  } else {\n+    t2 = $[6];\n+  }\n+  return t2;\n+}\n+\n+function Bar(t0) {\n+  const $ = _c(3);\n+  const { x, children } = t0;\n+  let t1;\n+  if ($[0] !== x || $[1] !== children) {\n+    t1 = (\n+      <>\n+        {x}\n+        {children}\n+      </>\n+    );\n+    $[0] = x;\n+    $[1] = children;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  return t1;\n+}\n+\n+function Baz(t0) {\n+  const { i } = t0;\n+  return i;\n+}\n+\n+function useX() {\n+  return \"x\";\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{ arr: [\"foo\", \"bar\"] }],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) xfooxbar\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-children.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-children.js\nnew file mode 100644\nindex 00000000000..eab907e09e2\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-children.js\n@@ -0,0 +1,36 @@\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        return (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}>Test</Baz>\n+          </Bar>\n+        );\n+      })}\n+    </>\n+  );\n+}\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-duplicate-prop.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-duplicate-prop.expect.md\nnew file mode 100644\nindex 00000000000..77fd38aea1e\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-duplicate-prop.expect.md\n@@ -0,0 +1,132 @@\n+\n+## Input\n+\n+```javascript\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        return (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}></Baz>\n+            <Foo i={i}></Foo>\n+          </Bar>\n+        );\n+      })}\n+    </>\n+  );\n+}\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function Foo({k}) {\n+  return k;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @enableJsxOutlining\n+function Component(t0) {\n+  const $ = _c(7);\n+  const { arr } = t0;\n+  const x = useX();\n+  let t1;\n+  if ($[0] !== x || $[1] !== arr) {\n+    let t2;\n+    if ($[3] !== x) {\n+      t2 = (i, id) => (\n+        <Bar key={id} x={x}>\n+          <Baz i={i} />\n+          <Foo i={i} />\n+        </Bar>\n+      );\n+      $[3] = x;\n+      $[4] = t2;\n+    } else {\n+      t2 = $[4];\n+    }\n+    t1 = arr.map(t2);\n+    $[0] = x;\n+    $[1] = arr;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  let t2;\n+  if ($[5] !== t1) {\n+    t2 = <>{t1}</>;\n+    $[5] = t1;\n+    $[6] = t2;\n+  } else {\n+    t2 = $[6];\n+  }\n+  return t2;\n+}\n+\n+function Bar(t0) {\n+  const $ = _c(3);\n+  const { x, children } = t0;\n+  let t1;\n+  if ($[0] !== x || $[1] !== children) {\n+    t1 = (\n+      <>\n+        {x}\n+        {children}\n+      </>\n+    );\n+    $[0] = x;\n+    $[1] = children;\n+    $[2] = t1;\n+  } else {\n+    t1 = $[2];\n+  }\n+  return t1;\n+}\n+\n+function Baz(t0) {\n+  const { i } = t0;\n+  return i;\n+}\n+\n+function Foo(t0) {\n+  const { k } = t0;\n+  return k;\n+}\n+\n+function useX() {\n+  return \"x\";\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{ arr: [\"foo\", \"bar\"] }],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) xfooxbar\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-duplicate-prop.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-duplicate-prop.js\nnew file mode 100644\nindex 00000000000..20c6bd934a5\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/todo.jsx-outlining-duplicate-prop.js\n@@ -0,0 +1,41 @@\n+// @enableJsxOutlining\n+function Component({arr}) {\n+  const x = useX();\n+  return (\n+    <>\n+      {arr.map((i, id) => {\n+        return (\n+          <Bar key={id} x={x}>\n+            <Baz i={i}></Baz>\n+            <Foo i={i}></Foo>\n+          </Bar>\n+        );\n+      })}\n+    </>\n+  );\n+}\n+function Bar({x, children}) {\n+  return (\n+    <>\n+      {x}\n+      {children}\n+    </>\n+  );\n+}\n+\n+function Baz({i}) {\n+  return i;\n+}\n+\n+function Foo({k}) {\n+  return k;\n+}\n+\n+function useX() {\n+  return 'x';\n+}\n+\n+export const FIXTURE_ENTRYPOINT = {\n+  fn: Component,\n+  params: [{arr: ['foo', 'bar']}],\n+};\n",
			"diffSize": 40867,
			"diffTruncated": false,
			"filterResult": {
				"included": true
			},
			"associatedPR": {
				"number": 30956,
				"title": "JSX Outlining",
				"state": "closed",
				"draft": false,
				"merged": true,
				"branch": "outline-jsx-final",
				"baseBranch": "main",
				"author": "gsathya",
				"body": "Currently, the react compiler can not compile within callbacks which can potentially cause over rendering. Consider this example:\r\n```jsx\r\nfunction Component(countries, onDelete) {\r\n  const name = useFoo();\r\n  return countries.map(() => {\r\n    return (\r\n      <Foo>\r\n        <Bar name={name}/>\r\n        <Baz onclick={onDelete} />\r\n      </Foo>\r\n    );\r\n  });\r\n}\r\n```\r\n\r\nIn this case, there's no memoization of the nested jsx elements. But instead if we were to manually refactor the nested jsx into separate component like this: \r\n```jsx\r\nfunction Component(countries, onDelete) {\r\n  const name = useFoo();\r\n  return countries.map(() => {\r\n    return <Temp name={name} onDelete={onDelete} />;\r\n  });\r\n}\r\n\r\nfunction Temp({ name, onDelete }) {\r\n  return (\r\n    <Foo>\r\n      <Bar name={name} />\r\n      <Baz onclick={onDelete} />\r\n    </Foo>\r\n  );\r\n}\r\n\r\n```\r\n\r\nThe compiler can now optimise both these components:\r\n```jsx\r\nfunction Component(countries, onDelete) {\r\n  const $ = _c(4);\r\n  const name = useFoo();\r\n  let t0;\r\n  if ($[0] !== name || $[1] !== onDelete || $[2] !== countries) {\r\n    t0 = countries.map(() => <Temp name={name} onDelete={onDelete} />);\r\n    $[0] = name;\r\n    $[1] = onDelete;\r\n    $[2] = countries;\r\n    $[3] = t0;\r\n  } else {\r\n    t0 = $[3];\r\n  }\r\n  return t0;\r\n}\r\n\r\nfunction Temp(t0) {\r\n  const $ = _c(7);\r\n  const { name, onDelete } = t0;\r\n  let t1;\r\n  if ($[0] !== name) {\r\n    t1 = <Bar name={name} />;\r\n    $[0] = name;\r\n    $[1] = t1;\r\n  } else {\r\n    t1 = $[1];\r\n  }\r\n  let t2;\r\n  if ($[2] !== onDelete) {\r\n    t2 = <Baz onclick={onDelete} />;\r\n    $[2] = onDelete;\r\n    $[3] = t2;\r\n  } else {\r\n    t2 = $[3];\r\n  }\r\n  let t3;\r\n  if ($[4] !== t1 || $[5] !== t2) {\r\n    t3 = (\r\n      <Foo>\r\n        {t1}\r\n        {t2}\r\n      </Foo>\r\n    );\r\n    $[4] = t1;\r\n    $[5] = t2;\r\n    $[6] = t3;\r\n  } else {\r\n    t3 = $[6];\r\n  }\r\n  return t3;\r\n}\r\n```\r\n\r\nNow, when `countries` is updated by adding one single value,  only the newly added value is re-rendered and not the entire list. Rather than having to do this manually, this PR teaches the react compiler to do this transformation.\r\n\r\nThis PR adds a new pass (`OutlineJsx`) to capture nested jsx statements and outline them in a separate component. This newly outlined component can then by memoized by the compiler, giving us more fine grained rendering.\r\n\r\nThere's a lot of improvements we can do in the future:\r\n- For now, we only outline nested jsx inside callbacks, but this can be extended in the future (for ex, to outline nested jsx inside loops).\r\n\r\n```jsx\r\nfunction Component(arr) {\r\n  const jsx = [];\r\n  for (const i of arr) {\r\n    jsx.push(\r\n      // this nested jsx can be outlined\r\n      <Bar>\r\n        <Baz i={i}></Baz>\r\n      </Bar>,\r\n    );\r\n  }\r\n  return jsx;\r\n}\r\n```\r\n- Only the JSX expression statements are outlined, none of the other statements that flow into the jsx are outlined. This is a bit tricky as we must only outline non-mutating statements using our effects analysis.\r\n```jsx\r\nfunction Component(arr) {\r\n  return arr.map((i) => {\r\n    // this statement should not be outlined\r\n    const y = mutate(i);\r\n    // this statement can be outlined\r\n    const x = { i };\r\n    return (\r\n      <Bar>\r\n        <Baz x={x} y={y}></Baz>\r\n      </Bar>\r\n    );\r\n  });\r\n}\r\n```",
				"labels": ["CLA Signed", "React Core Team"],
				"requestedReviewers": [],
				"reviews": [
					{
						"id": 2353128563,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2353128914,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2361434763,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2361441470,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2361444389,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2361447348,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2361448935,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2361450705,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2361451601,
						"state": "COMMENTED",
						"author": "josephsavona"
					},
					{
						"id": 2361454602,
						"state": "COMMENTED",
						"author": "josephsavona",
						"body": "This is really exciting! Seems pretty close, see comments about duplicate attribute names"
					}
				],
				"comments": [
					{
						"id": 2349345580,
						"body": "[vc]: #czrgJCE66VzwC4YN3MIjx2Zpz/o0UW6t4gNJulS9PXg=:eyJpc01vbm9yZXBvIjp0cnVlLCJ0eXBlIjoiZ2l0aHViIiwicHJvamVjdHMiOlt7Im5hbWUiOiJyZWFjdC1jb21waWxlci1wbGF5Z3JvdW5kIiwicm9vdERpcmVjdG9yeSI6ImNvbXBpbGVyL2FwcHMvcGxheWdyb3VuZCIsImluc3BlY3RvclVybCI6Imh0dHBzOi8vdmVyY2VsLmNvbS9mYm9wZW5zb3VyY2UvcmVhY3QtY29tcGlsZXItcGxheWdyb3VuZC9HSkJ0alh1bkpxeXZIczRzc0dnR2htN2FqVjNZIiwicHJldmlld1VybCI6InJlYWN0LWNvbXBpbGVyLXBsYXlncm91bmQtZ2l0LWZvcmstZ3NhdGh5YS1jMjY1MTItZmJvcGVuc291cmNlLnZlcmNlbC5hcHAiLCJuZXh0Q29tbWl0U3RhdHVzIjoiREVQTE9ZRUQiLCJsaXZlRmVlZGJhY2siOnsicmVzb2x2ZWQiOjAsInVucmVzb2x2ZWQiOjAsInRvdGFsIjowLCJsaW5rIjoicmVhY3QtY29tcGlsZXItcGxheWdyb3VuZC1naXQtZm9yay1nc2F0aHlhLWMyNjUxMi1mYm9wZW5zb3VyY2UudmVyY2VsLmFwcCJ9fV19\n**The latest updates on your projects**. Learn more about [Vercel for Git â†—ï¸Ž](https://vercel.link/github-learn-more)\n\n| Name | Status | Preview | Comments | Updated (UTC) |\n| :--- | :----- | :------ | :------- | :------ |\n| **react-compiler-playground** | âœ… Ready ([Inspect](https://vercel.com/fbopensource/react-compiler-playground/GJBtjXunJqyvHs4ssGgGhm7ajV3Y)) | [Visit Preview](https://vercel.live/open-feedback/react-compiler-playground-git-fork-gsathya-c26512-fbopensource.vercel.app?via=pr-comment-visit-preview-link&passThrough=1) | ðŸ’¬ [**Add feedback**](https://vercel.live/open-feedback/react-compiler-playground-git-fork-gsathya-c26512-fbopensource.vercel.app?via=pr-comment-feedback-link) | Oct 17, 2024 5:13pm |\n\n",
						"author": "vercel[bot]",
						"createdAt": "2024-09-13T16:28:45Z"
					},
					{
						"id": 2397352964,
						"body": "Awesome! Looking forward to reading through this. Quick question:\r\n\r\n> This PR adds a new HIR node (StartJsx) to track when the jsx statement starts, which lets us start capturing nested jsx expressions.\r\n\r\nWhy do we need this as an instruction, vs doing a quick scan through the instructions to find the outermost JSX instruction?",
						"author": "josephsavona",
						"createdAt": "2024-10-07T16:12:32Z"
					},
					{
						"id": 2397499381,
						"body": "> Why do we need this as an instruction, vs doing a quick scan through the instructions to find the outermost JSX instruction?\r\n\r\nYeah, this is a good question! I initially started with the scan approach but then hit a roadblock for this case:\r\n\r\n```jsx\r\n// @enableJsxOutlining\r\nfunction T({ t, a, b }) {\r\n  return t.map(() => {\r\n    let x = <Foo a={a} />\r\n    let y = <Baz b={b} />\r\n    // ... potential shenanigans ...\r\n    return <Bar>{y}{x}</Bar>\r\n  });\r\n}\r\n\r\nfunction B({t, a, b }) {\r\n  return t.map(() => <Bar><Foo a={com(a)} /><Baz b={b} /></Bar>)\r\n}\r\n```\r\n\r\nHere we want to differentiate between the two cases and not outline the first example. The jsx expressions, in either case, aren't in a consecutive sequence to make the quick scan work. For the second case, the children are read as jsx expressions and not from a local. This is potentially a way to differentiate but doesn't seem future proof as lowering to a local shouldn't have any semantic change, so I can see us doing this as part of some future change. I ended up going with the `StartJsx` (similar to `StartMemoize`) to be sure that we're inside a jsx expression.",
						"author": "gsathya",
						"createdAt": "2024-10-07T17:28:01Z"
					},
					{
						"id": 2398208939,
						"body": "Hmm, it seems pretty reasonable to just use a scan and exclude StoreLocal, which would reject the first example and allow the second. We could always expand to allow StoreLocal if we determined that it was only used once, in the subsequent JSX code. This could be a backwards traversal with a narrow allowlist of instructions like jsx, primitives, globals. \r\n\r\nIt's really really nice to avoid adding instruction variants.",
						"author": "josephsavona",
						"createdAt": "2024-10-07T23:54:57Z"
					},
					{
						"id": 2405378543,
						"body": ">  This could be a backwards traversal with a narrow allowlist of instructions like jsx, primitives, globals.\r\n\r\nOh good call! I've updated the PR to do this instead",
						"author": "gsathya",
						"createdAt": "2024-10-10T15:02:51Z"
					}
				],
				"htmlUrl": "https://github.com/facebook/react/pull/30956"
			}
		},
		{
			"sha": "bf7e210cb5672685bfe992a3b253880f5a3d47f5",
			"message": "tests[react-devtools]: added tests for Compiler integration (#31241)\n\nAdds tests for Compiler integration.\r\n\r\nThis includes:\r\n- Tests against Compiler from source.\r\n- Versioned (18.2 - <19) tests against Compiler from npm.\r\n\r\nFor tests against React 18.2, I had to download `react-compiler-runtime`\r\nfrom npm and put it to `react/compiler-runtime.js`.",
			"user": "hoxyq",
			"timestamp": "2024-10-17T08:02:41Z",
			"author": {
				"name": "Ruslan Lesiutin",
				"email": "rdlesyutin@gmail.com",
				"username": "hoxyq"
			},
			"files": {
				"added": [
					"packages/react-devtools-shared/src/__tests__/compiler-integration-test.js"
				],
				"modified": [
					".github/workflows/devtools_regression_tests.yml",
					"scripts/ci/download_devtools_regression_build.js"
				],
				"removed": []
			},
			"diff": "diff --git a/.github/workflows/devtools_regression_tests.yml b/.github/workflows/devtools_regression_tests.yml\nindex be4c38e2561..213f58218cc 100644\n--- a/.github/workflows/devtools_regression_tests.yml\n+++ b/.github/workflows/devtools_regression_tests.yml\n@@ -103,6 +103,7 @@ jobs:\n           - \"16.8\" # hooks\n           - \"17.0\"\n           - \"18.0\"\n+          - \"18.2\" # compiler polyfill\n     continue-on-error: true\n     steps:\n       - uses: actions/checkout@v4\ndiff --git a/packages/react-devtools-shared/src/__tests__/compiler-integration-test.js b/packages/react-devtools-shared/src/__tests__/compiler-integration-test.js\nnew file mode 100644\nindex 00000000000..25bbf59488f\n--- /dev/null\n+++ b/packages/react-devtools-shared/src/__tests__/compiler-integration-test.js\n@@ -0,0 +1,101 @@\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ *\n+ * @flow\n+ */\n+\n+import {getVersionedRenderImplementation} from './utils';\n+\n+describe('CompilerIntegration', () => {\n+  global.IS_REACT_ACT_ENVIRONMENT = true;\n+  let React;\n+  let act;\n+  let useMemoCache;\n+\n+  beforeEach(() => {\n+    React = require('react');\n+    require('react-dom');\n+    require('react-dom/client');\n+    useMemoCache = require('react/compiler-runtime').c;\n+\n+    const utils = require('./utils');\n+    act = utils.act;\n+  });\n+\n+  afterEach(() => {\n+    jest.restoreAllMocks();\n+  });\n+\n+  const {render} = getVersionedRenderImplementation();\n+\n+  // @reactVersion >= 18.2\n+  it('By default, component display names should not have Forget prefix', () => {\n+    const hook = global.__REACT_DEVTOOLS_GLOBAL_HOOK__;\n+    const reactDOMFiberRendererInterface = hook.rendererInterfaces.get(1);\n+    expect(reactDOMFiberRendererInterface).not.toBeFalsy();\n+\n+    const Foo = () => {\n+      // eslint-disable-next-line no-unused-vars\n+      const [val, setVal] = React.useState(null);\n+\n+      return (\n+        <div>\n+          <Bar />\n+        </div>\n+      );\n+    };\n+    const Bar = () => <div>Hi!</div>;\n+\n+    act(() => render(<Foo />));\n+\n+    expect(\n+      reactDOMFiberRendererInterface\n+        .getDisplayNameForElementID(2)\n+        .indexOf('Forget'),\n+    ).toBe(-1);\n+    expect(\n+      reactDOMFiberRendererInterface\n+        .getDisplayNameForElementID(3)\n+        .indexOf('Forget'),\n+    ).toBe(-1);\n+  });\n+\n+  // For React 18.2, this will install uMC polyfill from react-compiler-runtime available on npm.\n+  // @reactVersion >= 18.2\n+  it('If useMemoCache used, the corresponding displayName for a component should have Forget prefix', () => {\n+    const hook = global.__REACT_DEVTOOLS_GLOBAL_HOOK__;\n+    const reactDOMFiberRendererInterface = hook.rendererInterfaces.get(1);\n+    expect(reactDOMFiberRendererInterface).not.toBeFalsy();\n+\n+    const Foo = () => {\n+      // eslint-disable-next-line no-unused-vars\n+      const $ = useMemoCache(1);\n+      // eslint-disable-next-line no-unused-vars\n+      const [val, setVal] = React.useState(null);\n+\n+      return (\n+        <div>\n+          <Bar />\n+        </div>\n+      );\n+    };\n+    const Bar = () => <div>Hi!</div>;\n+\n+    act(() => render(<Foo />));\n+\n+    // useMemoCache is only used by Foo component\n+    expect(\n+      reactDOMFiberRendererInterface\n+        .getDisplayNameForElementID(2)\n+        .indexOf('Forget'),\n+    ).toBe(0);\n+    expect(\n+      reactDOMFiberRendererInterface\n+        .getDisplayNameForElementID(3)\n+        .indexOf('Forget'),\n+    ).toBe(-1);\n+  });\n+});\ndiff --git a/scripts/ci/download_devtools_regression_build.js b/scripts/ci/download_devtools_regression_build.js\nindex 01ef377094c..7195c194927 100755\n--- a/scripts/ci/download_devtools_regression_build.js\n+++ b/scripts/ci/download_devtools_regression_build.js\n@@ -82,11 +82,12 @@ async function downloadRegressionBuild() {\n   );\n   await exec(`mv ${movePackageString} ${buildPath}`);\n \n+  const reactVersion = semver.coerce(version).version;\n   // For React versions earlier than 18.0.0, we explicitly scheduler v0.20.1, which\n   // is the first version that has unstable_mock, which DevTools tests need, but also\n   // has Scheduler.unstable_trace, which, although we don't use in DevTools tests\n   // is imported by older React versions and will break if it's not there\n-  if (semver.lte(semver.coerce(version).version, '18.0.0')) {\n+  if (semver.lte(reactVersion, '18.0.0')) {\n     await exec(`npm install --prefix ${REGRESSION_FOLDER} scheduler@0.20.1`);\n   }\n \n@@ -108,6 +109,22 @@ async function downloadRegressionBuild() {\n       )} ${buildPath}`\n     );\n   }\n+\n+  if (semver.gte(reactVersion, '18.2.0') && semver.lt(reactVersion, '19')) {\n+    console.log(chalk.white(`Downloading react-compiler-runtime\\n`));\n+    await exec(\n+      `npm install --prefix ${REGRESSION_FOLDER} react-compiler-runtime`\n+    );\n+\n+    console.log(\n+      chalk.white(\n+        `Moving react-compiler-runtime to react/compiler-runtime.js\\n`\n+      )\n+    );\n+    await exec(\n+      `mv ${REGRESSION_FOLDER}/node_modules/react-compiler-runtime/dist/index.js ${buildPath}/react/compiler-runtime.js`\n+    );\n+  }\n }\n \n async function main() {\n",
			"diffSize": 5210,
			"diffTruncated": false,
			"filterResult": {
				"included": true
			},
			"associatedPR": {
				"number": 31241,
				"title": "tests[react-devtools]: added tests for Compiler integration",
				"state": "closed",
				"draft": false,
				"merged": true,
				"branch": "react-devtools/compiler-integration-tests",
				"baseBranch": "main",
				"author": "hoxyq",
				"body": "Adds tests for Compiler integration.\r\n\r\nThis includes:\r\n- Tests against Compiler from source.\r\n- Versioned (18.2 - <19) tests against Compiler from npm.\r\n\r\nFor tests against React 18.2, I had to download `react-compiler-runtime` from npm and put it to `react/compiler-runtime.js`.\r\n",
				"labels": ["CLA Signed", "React Core Team"],
				"requestedReviewers": [],
				"reviews": [
					{
						"id": 2373503494,
						"state": "APPROVED",
						"author": "poteto",
						"body": "Looks good, I think given that we don't have any tests for this yet, I'm inclined to say that we ship this now and iterate. There might be a better way to handle the react-compiler-runtime package case but that doesn't need to block "
					},
					{
						"id": 2373558820,
						"state": "COMMENTED",
						"author": "hoxyq"
					}
				],
				"comments": [
					{
						"id": 2412073351,
						"body": "[vc]: #CCRhMvLUHw5tnjdf4ES32Azgjbf2VaHZneF+kYqNM+U=:eyJpc01vbm9yZXBvIjp0cnVlLCJ0eXBlIjoiZ2l0aHViIiwicHJvamVjdHMiOlt7Im5hbWUiOiJyZWFjdC1jb21waWxlci1wbGF5Z3JvdW5kIiwicm9vdERpcmVjdG9yeSI6ImNvbXBpbGVyL2FwcHMvcGxheWdyb3VuZCIsImluc3BlY3RvclVybCI6Imh0dHBzOi8vdmVyY2VsLmNvbS9mYm9wZW5zb3VyY2UvcmVhY3QtY29tcGlsZXItcGxheWdyb3VuZC9BanRZQW0xYlR5cXllYzJ6SG9ZTVM4cjlrS1RoIiwicHJldmlld1VybCI6InJlYWN0LWNvbXBpbGVyLXBsYXlncm91bmQtZ2l0LWZvcmstaG94eXEtcmUtZjlhYTE2LWZib3BlbnNvdXJjZS52ZXJjZWwuYXBwIiwibmV4dENvbW1pdFN0YXR1cyI6IkRFUExPWUVEIiwibGl2ZUZlZWRiYWNrIjp7InJlc29sdmVkIjowLCJ1bnJlc29sdmVkIjowLCJ0b3RhbCI6MCwibGluayI6InJlYWN0LWNvbXBpbGVyLXBsYXlncm91bmQtZ2l0LWZvcmstaG94eXEtcmUtZjlhYTE2LWZib3BlbnNvdXJjZS52ZXJjZWwuYXBwIn19XX0=\n**The latest updates on your projects**. Learn more about [Vercel for Git â†—ï¸Ž](https://vercel.link/github-learn-more)\n\n| Name | Status | Preview | Comments | Updated (UTC) |\n| :--- | :----- | :------ | :------- | :------ |\n| **react-compiler-playground** | âœ… Ready ([Inspect](https://vercel.com/fbopensource/react-compiler-playground/AjtYAm1bTyqyec2zHoYMS8r9kKTh)) | [Visit Preview](https://vercel.live/open-feedback/react-compiler-playground-git-fork-hoxyq-re-f9aa16-fbopensource.vercel.app?via=pr-comment-visit-preview-link&passThrough=1) | ðŸ’¬ [**Add feedback**](https://vercel.live/open-feedback/react-compiler-playground-git-fork-hoxyq-re-f9aa16-fbopensource.vercel.app?via=pr-comment-feedback-link) | Oct 14, 2024 7:52pm |\n\n",
						"author": "vercel[bot]",
						"createdAt": "2024-10-14T19:41:16Z"
					},
					{
						"id": 2412077722,
						"body": "\n<!--\n  0 failure: \n  0 warning: \n  \n  1 markdown notices\n  DangerID: danger-id-stable;\n-->\n\n\n\n\nComparing: 13411e4589f3d999727c5322781e2dd7bef3b256...16c30dc3de43c1cc162adebca6694acf0b750f3a\n\n## Critical size changes\n\nIncludes critical production bundles, as well as any change greater than 2%:\n\n\n  | Name | +/- | Base | Current | +/- gzip | Base gzip | Current gzip |\n  | ---- | --- | ---- | ------- | -------- | --------- | ------------ |\n| [oss-stable/react-dom/cjs/react-dom.production.js](https://react-builds.vercel.app/commits/16c30dc3de43c1cc162adebca6694acf0b750f3a/files/oss-stable/react-dom/cjs/react-dom.production.js?compare=13411e4589f3d999727c5322781e2dd7bef3b256) | **=** | 6.68 kB | 6.68 kB | = | 1.82 kB | 1.82 kB\n| [oss-stable/react-dom/cjs/react-dom-client.production.js](https://react-builds.vercel.app/commits/16c30dc3de43c1cc162adebca6694acf0b750f3a/files/oss-stable/react-dom/cjs/react-dom-client.production.js?compare=13411e4589f3d999727c5322781e2dd7bef3b256) | **=** | 506.33 kB | 506.33 kB | = | 90.58 kB | 90.58 kB\n| [oss-experimental/react-dom/cjs/react-dom.production.js](https://react-builds.vercel.app/commits/16c30dc3de43c1cc162adebca6694acf0b750f3a/files/oss-experimental/react-dom/cjs/react-dom.production.js?compare=13411e4589f3d999727c5322781e2dd7bef3b256) | **=** | 6.69 kB | 6.69 kB | = | 1.83 kB | 1.83 kB\n| [oss-experimental/react-dom/cjs/react-dom-client.production.js](https://react-builds.vercel.app/commits/16c30dc3de43c1cc162adebca6694acf0b750f3a/files/oss-experimental/react-dom/cjs/react-dom-client.production.js?compare=13411e4589f3d999727c5322781e2dd7bef3b256) | **=** | 511.26 kB | 511.26 kB | = | 91.30 kB | 91.30 kB\n| [facebook-www/ReactDOM-prod.classic.js](https://react-builds.vercel.app/commits/16c30dc3de43c1cc162adebca6694acf0b750f3a/files/facebook-www/ReactDOM-prod.classic.js?compare=13411e4589f3d999727c5322781e2dd7bef3b256) | **=** | 603.42 kB | 603.42 kB | = | 106.73 kB | 106.73 kB\n| [facebook-www/ReactDOM-prod.modern.js](https://react-builds.vercel.app/commits/16c30dc3de43c1cc162adebca6694acf0b750f3a/files/facebook-www/ReactDOM-prod.modern.js?compare=13411e4589f3d999727c5322781e2dd7bef3b256) | **=** | 579.61 kB | 579.61 kB | = | 102.82 kB | 102.82 kB\n\n## Significant size changes\n\nIncludes any change greater than 0.2%:\n\n(No significant changes)\n\n<p align=\"right\">\n  Generated by :no_entry_sign: <a href=\"https://danger.systems/js\">dangerJS</a> against bcd54a068bf8cf55bfbe37aefbfc202659ca0214\n</p>\n",
						"author": "react-sizebot",
						"createdAt": "2024-10-14T19:44:23Z"
					}
				],
				"htmlUrl": "https://github.com/facebook/react/pull/31241"
			}
		}
	]
}
