{
	"date": "2025-09-14",
	"commits": [
		{
			"sha": "1161f1b8ba860a34602fc4aa211ea9f5b28c30eb",
			"message": "fix: eraser can handle dots without regressing prior performance improvements (#9946)\n\nCo-authored-by: M√°rk Tolm√°cs <mark@lazycat.hu>",
			"user": "cTangonan123",
			"timestamp": "2025-09-14T11:33:43Z",
			"author": {
				"name": "Christopher Tangonan",
				"email": "161169629+cTangonan123@users.noreply.github.com",
				"username": "cTangonan123"
			},
			"files": {
				"added": [],
				"modified": [
					"packages/element/src/renderElement.ts",
					"packages/excalidraw/eraser/index.ts",
					"packages/math/src/segment.ts"
				],
				"removed": []
			},
			"diff": "diff --git a/packages/element/src/renderElement.ts b/packages/element/src/renderElement.ts\nindex 008d6afc4a0b..8c17863ee03b 100644\n--- a/packages/element/src/renderElement.ts\n+++ b/packages/element/src/renderElement.ts\n@@ -1,7 +1,14 @@\n import rough from \"roughjs/bin/rough\";\n import { getStroke } from \"perfect-freehand\";\n \n-import { isRightAngleRads } from \"@excalidraw/math\";\n+import {\n+  type GlobalPoint,\n+  isRightAngleRads,\n+  lineSegment,\n+  pointFrom,\n+  pointRotateRads,\n+  type Radians,\n+} from \"@excalidraw/math\";\n \n import {\n   BOUND_TEXT_PADDING,\n@@ -14,6 +21,7 @@ import {\n   getFontString,\n   isRTL,\n   getVerticalOffset,\n+  invariant,\n } from \"@excalidraw/common\";\n \n import type {\n@@ -32,7 +40,7 @@ import type {\n   InteractiveCanvasRenderConfig,\n } from \"@excalidraw/excalidraw/scene/types\";\n \n-import { getElementAbsoluteCoords } from \"./bounds\";\n+import { getElementAbsoluteCoords, getElementBounds } from \"./bounds\";\n import { getUncroppedImageElement } from \"./cropElement\";\n import { LinearElementEditor } from \"./linearElementEditor\";\n import {\n@@ -1039,6 +1047,66 @@ export function getFreeDrawPath2D(element: ExcalidrawFreeDrawElement) {\n }\n \n export function getFreeDrawSvgPath(element: ExcalidrawFreeDrawElement) {\n+  return getSvgPathFromStroke(getFreedrawOutlinePoints(element));\n+}\n+\n+export function getFreedrawOutlineAsSegments(\n+  element: ExcalidrawFreeDrawElement,\n+  points: [number, number][],\n+  elementsMap: ElementsMap,\n+) {\n+  const bounds = getElementBounds(\n+    {\n+      ...element,\n+      angle: 0 as Radians,\n+    },\n+    elementsMap,\n+  );\n+  const center = pointFrom<GlobalPoint>(\n+    (bounds[0] + bounds[2]) / 2,\n+    (bounds[1] + bounds[3]) / 2,\n+  );\n+\n+  invariant(points.length >= 2, \"Freepath outline must have at least 2 points\");\n+\n+  return points.slice(2).reduce(\n+    (acc, curr) => {\n+      acc.push(\n+        lineSegment<GlobalPoint>(\n+          acc[acc.length - 1][1],\n+          pointRotateRads(\n+            pointFrom<GlobalPoint>(curr[0] + element.x, curr[1] + element.y),\n+            center,\n+            element.angle,\n+          ),\n+        ),\n+      );\n+      return acc;\n+    },\n+    [\n+      lineSegment<GlobalPoint>(\n+        pointRotateRads(\n+          pointFrom<GlobalPoint>(\n+            points[0][0] + element.x,\n+            points[0][1] + element.y,\n+          ),\n+          center,\n+          element.angle,\n+        ),\n+        pointRotateRads(\n+          pointFrom<GlobalPoint>(\n+            points[1][0] + element.x,\n+            points[1][1] + element.y,\n+          ),\n+          center,\n+          element.angle,\n+        ),\n+      ),\n+    ],\n+  );\n+}\n+\n+export function getFreedrawOutlinePoints(element: ExcalidrawFreeDrawElement) {\n   // If input points are empty (should they ever be?) return a dot\n   const inputPoints = element.simulatePressure\n     ? element.points\n@@ -1057,7 +1125,7 @@ export function getFreeDrawSvgPath(element: ExcalidrawFreeDrawElement) {\n     last: !!element.lastCommittedPoint, // LastCommittedPoint is added on pointerup\n   };\n \n-  return getSvgPathFromStroke(getStroke(inputPoints as number[][], options));\n+  return getStroke(inputPoints as number[][], options) as [number, number][];\n }\n \n function med(A: number[], B: number[]) {\ndiff --git a/packages/excalidraw/eraser/index.ts b/packages/excalidraw/eraser/index.ts\nindex 6fbe2bd4ca6b..567d0a396e0d 100644\n--- a/packages/excalidraw/eraser/index.ts\n+++ b/packages/excalidraw/eraser/index.ts\n@@ -1,11 +1,26 @@\n import { arrayToMap, easeOut, THEME } from \"@excalidraw/common\";\n+\n import {\n   computeBoundTextPosition,\n+  distanceToElement,\n+  doBoundsIntersect,\n   getBoundTextElement,\n+  getElementBounds,\n+  getFreedrawOutlineAsSegments,\n+  getFreedrawOutlinePoints,\n   intersectElementWithLineSegment,\n+  isArrowElement,\n+  isFreeDrawElement,\n+  isLineElement,\n   isPointInElement,\n } from \"@excalidraw/element\";\n-import { lineSegment, pointFrom } from \"@excalidraw/math\";\n+import {\n+  lineSegment,\n+  lineSegmentsDistance,\n+  pointFrom,\n+  polygon,\n+  polygonIncludesPoint,\n+} from \"@excalidraw/math\";\n \n import { getElementsInGroup } from \"@excalidraw/element\";\n \n@@ -13,6 +28,8 @@ import { shouldTestInside } from \"@excalidraw/element\";\n import { hasBoundTextElement, isBoundToContainer } from \"@excalidraw/element\";\n import { getBoundTextElementId } from \"@excalidraw/element\";\n \n+import type { Bounds } from \"@excalidraw/element\";\n+\n import type { GlobalPoint, LineSegment } from \"@excalidraw/math/types\";\n import type { ElementsMap, ExcalidrawElement } from \"@excalidraw/element/types\";\n \n@@ -96,6 +113,7 @@ export class EraserTrail extends AnimatedTrail {\n           pathSegment,\n           element,\n           candidateElementsMap,\n+          this.app.state.zoom.value,\n         );\n \n         if (intersects) {\n@@ -131,6 +149,7 @@ export class EraserTrail extends AnimatedTrail {\n           pathSegment,\n           element,\n           candidateElementsMap,\n+          this.app.state.zoom.value,\n         );\n \n         if (intersects) {\n@@ -180,8 +199,33 @@ const eraserTest = (\n   pathSegment: LineSegment<GlobalPoint>,\n   element: ExcalidrawElement,\n   elementsMap: ElementsMap,\n+  zoom: number,\n ): boolean => {\n   const lastPoint = pathSegment[1];\n+\n+  // PERF: Do a quick bounds intersection test first because it's cheap\n+  const threshold = isFreeDrawElement(element) ? 15 : element.strokeWidth / 2;\n+  const segmentBounds = [\n+    Math.min(pathSegment[0][0], pathSegment[1][0]) - threshold,\n+    Math.min(pathSegment[0][1], pathSegment[1][1]) - threshold,\n+    Math.max(pathSegment[0][0], pathSegment[1][0]) + threshold,\n+    Math.max(pathSegment[0][1], pathSegment[1][1]) + threshold,\n+  ] as Bounds;\n+  const origElementBounds = getElementBounds(element, elementsMap);\n+  const elementBounds: Bounds = [\n+    origElementBounds[0] - threshold,\n+    origElementBounds[1] - threshold,\n+    origElementBounds[2] + threshold,\n+    origElementBounds[3] + threshold,\n+  ];\n+\n+  if (!doBoundsIntersect(segmentBounds, elementBounds)) {\n+    return false;\n+  }\n+\n+  // There are shapes where the inner area should trigger erasing\n+  // even though the eraser path segment doesn't intersect with or\n+  // get close to the shape's stroke\n   if (\n     shouldTestInside(element) &&\n     isPointInElement(lastPoint, element, elementsMap)\n@@ -189,6 +233,50 @@ const eraserTest = (\n     return true;\n   }\n \n+  // Freedraw elements are tested for erasure by measuring the distance\n+  // of the eraser path and the freedraw shape outline lines to a tolerance\n+  // which offers a good visual precision at various zoom levels\n+  if (isFreeDrawElement(element)) {\n+    const outlinePoints = getFreedrawOutlinePoints(element);\n+    const strokeSegments = getFreedrawOutlineAsSegments(\n+      element,\n+      outlinePoints,\n+      elementsMap,\n+    );\n+    const tolerance = Math.max(2.25, 5 / zoom); // NOTE: Visually fine-tuned approximation\n+\n+    for (const seg of strokeSegments) {\n+      if (lineSegmentsDistance(seg, pathSegment) <= tolerance) {\n+        return true;\n+      }\n+    }\n+\n+    const poly = polygon(\n+      ...(outlinePoints.map(([x, y]) =>\n+        pointFrom<GlobalPoint>(element.x + x, element.y + y),\n+      ) as GlobalPoint[]),\n+    );\n+\n+    // PERF: Check only one point of the eraser segment. If the eraser segment\n+    // start is inside the closed freedraw shape, the other point is either also\n+    // inside or the eraser segment will intersect the shape outline anyway\n+    if (polygonIncludesPoint(pathSegment[0], poly)) {\n+      return true;\n+    }\n+\n+    return false;\n+  } else if (\n+    isArrowElement(element) ||\n+    (isLineElement(element) && !element.polygon)\n+  ) {\n+    const tolerance = Math.max(\n+      element.strokeWidth,\n+      (element.strokeWidth * 2) / zoom,\n+    );\n+\n+    return distanceToElement(element, elementsMap, lastPoint) <= tolerance;\n+  }\n+\n   const boundTextElement = getBoundTextElement(element, elementsMap);\n \n   return (\ndiff --git a/packages/math/src/segment.ts b/packages/math/src/segment.ts\nindex dade79039b38..ae282bfee581 100644\n--- a/packages/math/src/segment.ts\n+++ b/packages/math/src/segment.ts\n@@ -177,3 +177,19 @@ export function lineSegmentIntersectionPoints<\n \n   return candidate;\n }\n+\n+export function lineSegmentsDistance<Point extends GlobalPoint | LocalPoint>(\n+  s1: LineSegment<Point>,\n+  s2: LineSegment<Point>,\n+): number {\n+  if (lineSegmentIntersectionPoints(s1, s2)) {\n+    return 0;\n+  }\n+\n+  return Math.min(\n+    distanceToLineSegment(s1[0], s2),\n+    distanceToLineSegment(s1[1], s2),\n+    distanceToLineSegment(s2[0], s1),\n+    distanceToLineSegment(s2[1], s1),\n+  );\n+}\n",
			"diffSize": 8637,
			"diffTruncated": false,
			"filterResult": {
				"included": true
			},
			"associatedPR": {
				"number": 9946,
				"title": "fix: eraser can handle dots without regressing prior performance improvements",
				"state": "closed",
				"draft": false,
				"merged": true,
				"branch": "fix/eraser_dots",
				"baseBranch": "master",
				"author": "cTangonan123",
				"body": "## Summary\r\nThis PR fixes an issue with the eraser tool where freehand dots were difficult to erase.\r\n\r\nThe solution works by:\r\n1. **Dot detection**: An element is classified as a dot if its bounding box diagonal is below a certain threshold.\r\n2. **Hit radius calculation**: For dots, we skip path-collision checks and instead compute a `hitRadius` based on the element‚Äôs `strokeWidth`.\r\n3. **Erase evaluation**: The eraser checks the distance between its last path point and the element‚Äôs center. If this distance is less than or equal to the `hitRadius`, the element is erased.\r\n\r\nThis approach ensures dots are erased reliably while preserving the previously employed performance enhancement of checking for intersecting paths for all elements larger than dots.\r\n\r\nhttps://github.com/user-attachments/assets/606b03e4-caf4-43dd-915f-337ba36bd800\r\n\r\n### Credits\r\ncredits to @Brikaa and @mtolmacs for specifying a more performant solution in treating a dot as a circle as opposed to an outline of its shape.\r\n\r\n### Feedback Welcome\r\nMore than happy to adjust as needed. If there's anything needed to improve or a more performant approach, I'm open to collaborating. Appreciate any suggestions or review comments!\r\n\r\ncc @mtolmacs @dwelle ‚Äì would appreciate any feedback you guys may have on this one!\r\n\r\nFixes #9762 \r\nIssues #9904 #9918 #9932 seem to all be concerned with the same behavior and could be closed as well.",
				"labels": [],
				"requestedReviewers": [],
				"reviews": [
					{
						"id": 3191681420,
						"state": "CHANGES_REQUESTED",
						"author": "mtolmacs"
					},
					{
						"id": 3194478467,
						"state": "COMMENTED",
						"author": "cTangonan123"
					},
					{
						"id": 3194479158,
						"state": "COMMENTED",
						"author": "cTangonan123"
					},
					{
						"id": 3194479417,
						"state": "COMMENTED",
						"author": "cTangonan123"
					},
					{
						"id": 3194480747,
						"state": "COMMENTED",
						"author": "cTangonan123"
					},
					{
						"id": 3197343370,
						"state": "COMMENTED",
						"author": "cTangonan123"
					},
					{
						"id": 3197356408,
						"state": "COMMENTED",
						"author": "cTangonan123"
					},
					{
						"id": 3197993236,
						"state": "CHANGES_REQUESTED",
						"author": "mtolmacs"
					},
					{
						"id": 3204302741,
						"state": "COMMENTED",
						"author": "cTangonan123"
					},
					{
						"id": 3204309143,
						"state": "COMMENTED",
						"author": "cTangonan123"
					}
				],
				"comments": [
					{
						"id": 3260206717,
						"body": "[vc]: #dM8ORA208Is2RBon7wMRaTno+UCu96kTuTILMSBMvag=:eyJpc01vbm9yZXBvIjp0cnVlLCJ0eXBlIjoiZ2l0aHViIiwicHJvamVjdHMiOlt7Im5hbWUiOiJkb2NzIiwicm9vdERpcmVjdG9yeSI6ImRldi1kb2NzIiwiaW5zcGVjdG9yVXJsIjoiaHR0cHM6Ly92ZXJjZWwuY29tL2V4Y2FsaWRyYXcvZG9jcy83ajJRZHRQY25pZlpxMXN4TkFKR2g1N2N6YnQzIiwicHJldmlld1VybCI6ImRvY3MtZ2l0LWZvcmstY3RhbmdvbmFuMTIzLWZpeC1lcmFzZXJkb3RzLWV4Y2FsaWRyYXcudmVyY2VsLmFwcCIsIm5leHRDb21taXRTdGF0dXMiOiJJR05PUkVEIn0seyJuYW1lIjoiZXhjYWxpZHJhdy1wYWNrYWdlLWV4YW1wbGUiLCJyb290RGlyZWN0b3J5IjoiZXhhbXBsZXMvd2l0aC1zY3JpcHQtaW4tYnJvd3NlciIsImluc3BlY3RvclVybCI6Imh0dHBzOi8vdmVyY2VsLmNvbS9leGNhbGlkcmF3L2V4Y2FsaWRyYXctcGFja2FnZS1leGFtcGxlLzJSYXpEWmFDaXZRWmZHSGo4TEQ2cmloZ3A3b24iLCJwcmV2aWV3VXJsIjoiZXhjYWxpZHJhdy1wYWNrYWdlLWV4YW1wbGUtZ2l0LWZvcmstY3RhbmdvbmFuLTMwMWJlNC1leGNhbGlkcmF3LnZlcmNlbC5hcHAiLCJuZXh0Q29tbWl0U3RhdHVzIjoiREVQTE9ZRUQifSx7Im5hbWUiOiJleGNhbGlkcmF3LXBhY2thZ2UtZXhhbXBsZS13aXRoLW5leHRqcyIsInJvb3REaXJlY3RvcnkiOiJleGFtcGxlcy93aXRoLW5leHRqcyIsImluc3BlY3RvclVybCI6Imh0dHBzOi8vdmVyY2VsLmNvbS9leGNhbGlkcmF3L2V4Y2FsaWRyYXctcGFja2FnZS1leGFtcGxlLXdpdGgtbmV4dGpzL0R5dGRqQU51WGFYcEdUZFR3cE1lYld4a2FxaVMiLCJwcmV2aWV3VXJsIjoiZXhjYWxpZHJhdy1wYWNrYWdlLWV4YW1wbGUtd2l0aC1uZXh0anMtZ2l0LWZvLWJhMTFjNC1leGNhbGlkcmF3LnZlcmNlbC5hcHAiLCJuZXh0Q29tbWl0U3RhdHVzIjoiREVQTE9ZRUQifSx7Im5hbWUiOiJleGNhbGlkcmF3Iiwicm9vdERpcmVjdG9yeSI6bnVsbCwiaW5zcGVjdG9yVXJsIjoiaHR0cHM6Ly92ZXJjZWwuY29tL2V4Y2FsaWRyYXcvZXhjYWxpZHJhdy8yOW9FdEYyN1F3SGJKVDVnQmQ3QVpQU3ZpbnFXIiwicHJldmlld1VybCI6ImV4Y2FsaWRyYXctZ2l0LWZvcmstY3RhbmdvbmFuMTIzLWZpeC1lcmFzZXJkb3RzLWV4Y2FsaWRyYXcudmVyY2VsLmFwcCIsIm5leHRDb21taXRTdGF0dXMiOiJERVBMT1lFRCJ9XX0=\nThe latest updates on your projects. Learn more about [Vercel for GitHub](https://vercel.link/github-learn-more).\n\n| Project | Deployment | Preview | Updated (UTC) |\n| :--- | :----- | :------ | :------ |\n| [excalidraw](https://vercel.com/excalidraw/excalidraw) | ![Ready](https://vercel.com/static/status/ready.svg) [Ready](https://vercel.com/excalidraw/excalidraw/29oEtF27QwHbJT5gBd7AZPSvinqW) | [Preview](https://excalidraw-git-fork-ctangonan123-fix-eraserdots-excalidraw.vercel.app) | Sep 14, 2025 10:27am |\n| [excalidraw-package-example](https://vercel.com/excalidraw/excalidraw-package-example) | ![Ready](https://vercel.com/static/status/ready.svg) [Ready](https://vercel.com/excalidraw/excalidraw-package-example/2RazDZaCivQZfGHj8LD6rihgp7on) | [Preview](https://excalidraw-package-example-git-fork-ctangonan-301be4-excalidraw.vercel.app) | Sep 14, 2025 10:27am |\n| [excalidraw-package-example-with-nextjs](https://vercel.com/excalidraw/excalidraw-package-example-with-nextjs) | ![Ready](https://vercel.com/static/status/ready.svg) [Ready](https://vercel.com/excalidraw/excalidraw-package-example-with-nextjs/DytdjANuXaXpGTdTwpMebWxkaqiS) | [Preview](https://excalidraw-package-example-with-nextjs-git-fo-ba11c4-excalidraw.vercel.app) | Sep 14, 2025 10:27am |\n\n<details><summary>1 Skipped Deployment</summary>\n\n| Project | Deployment | Preview | Updated (UTC) |\n| :--- | :----- | :------ | :------ |\n| [docs](https://vercel.com/excalidraw/docs) | ![Ignored](https://vercel.com/static/status/canceled.svg) [Ignored](https://vercel.com/excalidraw/docs/7j2QdtPcnifZq1sxNAJGh57czbt3) | [Preview](https://docs-git-fork-ctangonan123-fix-eraserdots-excalidraw.vercel.app) | Sep 14, 2025 10:27am |\n</details>\n\n\n\n\n",
						"author": "vercel[bot]",
						"createdAt": "2025-09-06T02:05:39Z"
					},
					{
						"id": 3284218880,
						"body": "@cTangonan123 during testing I found that the freedraw eraser test failed to delete some complex freedraws. Can you test with my commit and confirm this version works for you?",
						"author": "mtolmacs",
						"createdAt": "2025-09-12T08:07:13Z"
					},
					{
						"id": 3285711471,
						"body": "> @cTangonan123 during testing I found that the freedraw eraser test failed to delete some complex freedraws. Can you test with my commit and confirm this version works for you?\r\n\r\nYeah sure thing! @mtolmacs could you explain the scenario in which to test or provide a brief video? (whichever's easiest for you)",
						"author": "cTangonan123",
						"createdAt": "2025-09-12T15:22:43Z"
					},
					{
						"id": 3285928077,
						"body": "> > @cTangonan123 during testing I found that the freedraw eraser test failed to delete some complex freedraws. Can you test with my commit and confirm this version works for you?\r\n> \r\n> Yeah sure thing! @mtolmacs could you explain the scenario in which to test or provide a brief video? (whichever's easiest for you)\r\n\r\nDon't know if it helps, but here's just one test case:\r\n![Recording 2025-09-12 at 18 18 59](https://github.com/user-attachments/assets/7c34c6f0-7826-4711-90f6-dc40c0909f0e)\r\n\r\n",
						"author": "mtolmacs",
						"createdAt": "2025-09-12T16:19:44Z"
					},
					{
						"id": 3286167409,
						"body": "Oh man, @mtolmacs  I'm still learning üòÖ...However, I've picked up a lot just through this pr with you and reading through your modifications, in particular, how I can use the `visualdebug` ü§¶‚Äç‚ôÇÔ∏è So thanks for this! As for testing, It works great for the outline. \r\n\r\nI do want to mention one edge case I came across, which is when zoomed in past 100% if the eraser is within the outline and clicked and dragged, it will not erase until it crosses that distance/tolerance threshold of the approximated outline. Is that something we should consider too?\r\n\r\nI know the previous approach accounted for this. Could some form of it be used as a fallback, or would it be considered too costly in terms of performance?",
						"author": "cTangonan123",
						"createdAt": "2025-09-12T17:12:20Z"
					},
					{
						"id": 3288641127,
						"body": "@cTangonan123 fixed it. Anything else?",
						"author": "mtolmacs",
						"createdAt": "2025-09-13T17:06:56Z"
					},
					{
						"id": 3288672561,
						"body": "@mtolmacs works on all edge cases I was considering! üëç",
						"author": "cTangonan123",
						"createdAt": "2025-09-13T17:41:54Z"
					},
					{
						"id": 3289428787,
						"body": "> üöÄ Okay then, please merge it @cTangonan123 !\r\n\r\nOn it! Thanks @mtolmacs! picked up a ton working with you on this one! Really appreciate the help.",
						"author": "cTangonan123",
						"createdAt": "2025-09-14T10:29:29Z"
					},
					{
						"id": 3308225404,
						"body": "## Issues attributed to commits in this pull request\nThis pull request was merged and Sentry observed the following issues:\n\n* ‚ÄºÔ∏è [**TypeError: Cannot read properties of undefined (re...**](https://excalidraw.sentry.io/issues/6886069874/?referrer=github-pr-bot) in `production`\n\n\n<sub>Did you find this useful? React with a üëç or üëé</sub>",
						"author": "sentry[bot]",
						"createdAt": "2025-09-18T15:46:43Z"
					}
				],
				"htmlUrl": "https://github.com/excalidraw/excalidraw/pull/9946"
			}
		}
	]
}
