{
	"date": "2025-02-01",
	"commits": [
		{
			"sha": "302664e500c7f2ee44a1f107d8f4680c0254305b",
			"message": "fix: Elbow arrow z-index binding (#9067)",
			"user": "mtolmacs",
			"timestamp": "2025-02-01T18:21:03Z",
			"author": {
				"name": "Márk Tolmács",
				"email": "mark@lazycat.hu",
				"username": "mtolmacs"
			},
			"files": {
				"added": [],
				"modified": [
					"packages/excalidraw/actions/actionProperties.tsx",
					"packages/excalidraw/components/App.tsx",
					"packages/excalidraw/element/binding.ts",
					"packages/excalidraw/element/elbowArrow.ts",
					"packages/excalidraw/element/linearElementEditor.ts",
					"packages/excalidraw/element/mutateElement.ts",
					"packages/excalidraw/scene/comparisons.ts",
					"packages/excalidraw/utils.ts"
				],
				"removed": []
			},
			"diff": "diff --git a/packages/excalidraw/actions/actionProperties.tsx b/packages/excalidraw/actions/actionProperties.tsx\nindex 3e0768b26517..660d7e6794ce 100644\n--- a/packages/excalidraw/actions/actionProperties.tsx\n+++ b/packages/excalidraw/actions/actionProperties.tsx\n@@ -1605,6 +1605,8 @@ export const actionChangeArrowType = register({\n             elements,\n             elementsMap,\n             appState.zoom,\n+            false,\n+            true,\n           );\n         const endHoveredElement =\n           !newElement.endBinding &&\n@@ -1613,6 +1615,8 @@ export const actionChangeArrowType = register({\n             elements,\n             elementsMap,\n             appState.zoom,\n+            false,\n+            true,\n           );\n         const startElement = startHoveredElement\n           ? startHoveredElement\ndiff --git a/packages/excalidraw/components/App.tsx b/packages/excalidraw/components/App.tsx\nindex f16f88657455..dc81f9181eaa 100644\n--- a/packages/excalidraw/components/App.tsx\n+++ b/packages/excalidraw/components/App.tsx\n@@ -5770,7 +5770,10 @@ class App extends React.Component<AppProps, AppState> {\n         });\n       }\n       if (editingLinearElement?.lastUncommittedPoint != null) {\n-        this.maybeSuggestBindingAtCursor(scenePointer);\n+        this.maybeSuggestBindingAtCursor(\n+          scenePointer,\n+          editingLinearElement.elbowed,\n+        );\n       } else {\n         // causes stack overflow if not sync\n         flushSync(() => {\n@@ -5790,7 +5793,7 @@ class App extends React.Component<AppProps, AppState> {\n           this.state.startBoundElement,\n         );\n       } else {\n-        this.maybeSuggestBindingAtCursor(scenePointer);\n+        this.maybeSuggestBindingAtCursor(scenePointer, false);\n       }\n     }\n \n@@ -7728,6 +7731,7 @@ class App extends React.Component<AppProps, AppState> {\n         this.scene.getNonDeletedElementsMap(),\n         this.state.zoom,\n         isElbowArrow(element),\n+        isElbowArrow(element),\n       );\n \n       this.scene.insertElement(element);\n@@ -10005,15 +10009,20 @@ class App extends React.Component<AppProps, AppState> {\n     }\n   };\n \n-  private maybeSuggestBindingAtCursor = (pointerCoords: {\n-    x: number;\n-    y: number;\n-  }): void => {\n+  private maybeSuggestBindingAtCursor = (\n+    pointerCoords: {\n+      x: number;\n+      y: number;\n+    },\n+    considerAll: boolean,\n+  ): void => {\n     const hoveredBindableElement = getHoveredElementForBinding(\n       pointerCoords,\n       this.scene.getNonDeletedElements(),\n       this.scene.getNonDeletedElementsMap(),\n       this.state.zoom,\n+      false,\n+      considerAll,\n     );\n     this.setState({\n       suggestedBindings:\n@@ -10043,7 +10052,8 @@ class App extends React.Component<AppProps, AppState> {\n           this.scene.getNonDeletedElements(),\n           this.scene.getNonDeletedElementsMap(),\n           this.state.zoom,\n-          isArrowElement(linearElement) && isElbowArrow(linearElement),\n+          isElbowArrow(linearElement),\n+          isElbowArrow(linearElement),\n         );\n         if (\n           hoveredBindableElement != null &&\ndiff --git a/packages/excalidraw/element/binding.ts b/packages/excalidraw/element/binding.ts\nindex 615a484a47e5..5b45d982b1f2 100644\n--- a/packages/excalidraw/element/binding.ts\n+++ b/packages/excalidraw/element/binding.ts\n@@ -49,7 +49,11 @@ import type { ElementUpdate } from \"./mutateElement\";\n import { mutateElement } from \"./mutateElement\";\n import type Scene from \"../scene/Scene\";\n import { LinearElementEditor } from \"./linearElementEditor\";\n-import { arrayToMap, tupleToCoors } from \"../utils\";\n+import {\n+  arrayToMap,\n+  isBindingFallthroughEnabled,\n+  tupleToCoors,\n+} from \"../utils\";\n import { KEYS } from \"../keys\";\n import { getBoundTextElement, handleBindTextResize } from \"./textElement\";\n import { aabbForElement, getElementShape, pointInsideBounds } from \"../shapes\";\n@@ -75,6 +79,7 @@ import {\n   clamp,\n } from \"../../math\";\n import { segmentIntersectRectangleElement } from \"../../utils/geometry/shape\";\n+import { getElementsAtPosition } from \"../scene/comparisons\";\n \n export type SuggestedBinding =\n   | NonDeleted<ExcalidrawBindableElement>\n@@ -425,7 +430,8 @@ export const maybeBindLinearElement = (\n     elements,\n     elementsMap,\n     appState.zoom,\n-    isElbowArrow(linearElement) && isElbowArrow(linearElement),\n+    isElbowArrow(linearElement),\n+    isElbowArrow(linearElement),\n   );\n \n   if (hoveredElement !== null) {\n@@ -558,7 +564,64 @@ export const getHoveredElementForBinding = (\n   elementsMap: NonDeletedSceneElementsMap,\n   zoom?: AppState[\"zoom\"],\n   fullShape?: boolean,\n+  considerAllElements?: boolean,\n ): NonDeleted<ExcalidrawBindableElement> | null => {\n+  if (considerAllElements) {\n+    let cullRest = false;\n+    const candidateElements = getElementsAtPosition(\n+      elements,\n+      (element) =>\n+        isBindableElement(element, false) &&\n+        bindingBorderTest(\n+          element,\n+          pointerCoords,\n+          elementsMap,\n+          zoom,\n+          (fullShape ||\n+            !isBindingFallthroughEnabled(\n+              element as ExcalidrawBindableElement,\n+            )) &&\n+            // disable fullshape snapping for frame elements so we\n+            // can bind to frame children\n+            !isFrameLikeElement(element),\n+        ),\n+    ).filter((element) => {\n+      if (cullRest) {\n+        return false;\n+      }\n+\n+      if (!isBindingFallthroughEnabled(element as ExcalidrawBindableElement)) {\n+        cullRest = true;\n+      }\n+\n+      return true;\n+    }) as NonDeleted<ExcalidrawBindableElement>[] | null;\n+\n+    // Return early if there are no candidates or just one candidate\n+    if (!candidateElements || candidateElements.length === 0) {\n+      return null;\n+    }\n+\n+    if (candidateElements.length === 1) {\n+      return candidateElements[0] as NonDeleted<ExcalidrawBindableElement>;\n+    }\n+\n+    // Prefer the shape with the border being tested (if any)\n+    const borderTestElements = candidateElements.filter((element) =>\n+      bindingBorderTest(element, pointerCoords, elementsMap, zoom, false),\n+    );\n+    if (borderTestElements.length === 1) {\n+      return borderTestElements[0];\n+    }\n+\n+    // Prefer smaller shapes\n+    return candidateElements\n+      .sort(\n+        (a, b) => b.width ** 2 + b.height ** 2 - (a.width ** 2 + a.height ** 2),\n+      )\n+      .pop() as NonDeleted<ExcalidrawBindableElement>;\n+  }\n+\n   const hoveredElement = getElementAtPosition(\n     elements,\n     (element) =>\n@@ -570,7 +633,8 @@ export const getHoveredElementForBinding = (\n         zoom,\n         // disable fullshape snapping for frame elements so we\n         // can bind to frame children\n-        fullShape && !isFrameLikeElement(element),\n+        (fullShape || !isBindingFallthroughEnabled(element)) &&\n+          !isFrameLikeElement(element),\n       ),\n   );\n \n@@ -1220,6 +1284,8 @@ const getElligibleElementForBindingElement = (\n     elements,\n     elementsMap,\n     zoom,\n+    isElbowArrow(linearElement),\n+    isElbowArrow(linearElement),\n   );\n };\n \ndiff --git a/packages/excalidraw/element/elbowArrow.ts b/packages/excalidraw/element/elbowArrow.ts\nindex 921e73518572..498e59d71a10 100644\n--- a/packages/excalidraw/element/elbowArrow.ts\n+++ b/packages/excalidraw/element/elbowArrow.ts\n@@ -20,11 +20,11 @@ import {\n   bindPointToSnapToElementOutline,\n   distanceToBindableElement,\n   avoidRectangularCorner,\n-  getHoveredElementForBinding,\n   FIXED_BINDING_DISTANCE,\n   getHeadingForElbowArrowSnap,\n   getGlobalFixedPointForBindableElement,\n   snapToMid,\n+  getHoveredElementForBinding,\n } from \"./binding\";\n import type { Bounds } from \"./bounds\";\n import type { Heading } from \"./heading\";\n@@ -872,6 +872,8 @@ export const updateElbowArrowPoints = (\n   updates: {\n     points?: readonly LocalPoint[];\n     fixedSegments?: FixedSegment[] | null;\n+    startBinding?: FixedPointBinding | null;\n+    endBinding?: FixedPointBinding | null;\n   },\n   options?: {\n     isDragging?: boolean;\n@@ -953,17 +955,48 @@ export const updateElbowArrowPoints = (\n     hoveredStartElement,\n     hoveredEndElement,\n     ...rest\n-  } = getElbowArrowData(arrow, elementsMap, updatedPoints, options);\n+  } = getElbowArrowData(\n+    {\n+      x: arrow.x,\n+      y: arrow.y,\n+      startBinding:\n+        typeof updates.startBinding !== \"undefined\"\n+          ? updates.startBinding\n+          : arrow.startBinding,\n+      endBinding:\n+        typeof updates.endBinding !== \"undefined\"\n+          ? updates.endBinding\n+          : arrow.endBinding,\n+      startArrowhead: arrow.startArrowhead,\n+      endArrowhead: arrow.endArrowhead,\n+    },\n+    elementsMap,\n+    updatedPoints,\n+    options,\n+  );\n \n   const fixedSegments = updates.fixedSegments ?? arrow.fixedSegments ?? [];\n \n   ////\n   // 1. Renormalize the arrow\n   ////\n-  if (!updates.points && !updates.fixedSegments) {\n+  if (\n+    !updates.points &&\n+    !updates.fixedSegments &&\n+    !updates.startBinding &&\n+    !updates.endBinding\n+  ) {\n     return handleSegmentRenormalization(arrow, elementsMap);\n   }\n \n+  // Short circuit on no-op to avoid huge performance hit\n+  if (\n+    updates.startBinding === arrow.startBinding &&\n+    updates.endBinding === arrow.endBinding\n+  ) {\n+    return {};\n+  }\n+\n   ////\n   // 2. Just normal elbow arrow things\n   ////\n@@ -1010,6 +1043,7 @@ export const updateElbowArrowPoints = (\n \n   ////\n   // 5. Handle resize\n+  ////\n   if (updates.points && updates.fixedSegments) {\n     return updates;\n   }\n@@ -2120,6 +2154,7 @@ const getHoveredElements = (\n       nonDeletedSceneElementsMap,\n       zoom,\n       true,\n+      true,\n     ),\n     getHoveredElementForBinding(\n       tupleToCoors(origEndGlobalPoint),\n@@ -2127,6 +2162,7 @@ const getHoveredElements = (\n       nonDeletedSceneElementsMap,\n       zoom,\n       true,\n+      true,\n     ),\n   ];\n };\ndiff --git a/packages/excalidraw/element/linearElementEditor.ts b/packages/excalidraw/element/linearElementEditor.ts\nindex 99b369a7661c..380313067e5a 100644\n--- a/packages/excalidraw/element/linearElementEditor.ts\n+++ b/packages/excalidraw/element/linearElementEditor.ts\n@@ -444,6 +444,8 @@ export class LinearElementEditor {\n                 elements,\n                 elementsMap,\n                 appState.zoom,\n+                isElbowArrow(element),\n+                isElbowArrow(element),\n               )\n             : null;\n \n@@ -796,6 +798,7 @@ export class LinearElementEditor {\n           elements,\n           elementsMap,\n           app.state.zoom,\n+          linearElementEditor.elbowed,\n         ),\n       };\n \ndiff --git a/packages/excalidraw/element/mutateElement.ts b/packages/excalidraw/element/mutateElement.ts\nindex d5fcc1ff35d8..2f2a5d47f91b 100644\n--- a/packages/excalidraw/element/mutateElement.ts\n+++ b/packages/excalidraw/element/mutateElement.ts\n@@ -33,13 +33,16 @@ export const mutateElement = <TElement extends Mutable<ExcalidrawElement>>(\n \n   // casting to any because can't use `in` operator\n   // (see https://github.com/microsoft/TypeScript/issues/21732)\n-  const { points, fixedSegments, fileId } = updates as any;\n+  const { points, fixedSegments, fileId, startBinding, endBinding } =\n+    updates as any;\n \n   if (\n     isElbowArrow(element) &&\n     (Object.keys(updates).length === 0 || // normalization case\n       typeof points !== \"undefined\" || // repositioning\n-      typeof fixedSegments !== \"undefined\") // segment fixing\n+      typeof fixedSegments !== \"undefined\" || // segment fixing\n+      typeof startBinding !== \"undefined\" ||\n+      typeof endBinding !== \"undefined\") // manual binding to element\n   ) {\n     const elementsMap = toBrandedType<SceneElementsMap>(\n       Scene.getScene(element)?.getNonDeletedElementsMap() ?? new Map(),\n@@ -58,6 +61,8 @@ export const mutateElement = <TElement extends Mutable<ExcalidrawElement>>(\n         {\n           fixedSegments,\n           points,\n+          startBinding,\n+          endBinding,\n         },\n         {\n           isDragging: options?.isDragging,\ndiff --git a/packages/excalidraw/scene/comparisons.ts b/packages/excalidraw/scene/comparisons.ts\nindex 629fb371ebe2..47561fdf9fb2 100644\n--- a/packages/excalidraw/scene/comparisons.ts\n+++ b/packages/excalidraw/scene/comparisons.ts\n@@ -75,20 +75,23 @@ export const getElementsAtPosition = (\n   isAtPositionFn: (element: NonDeletedExcalidrawElement) => boolean,\n ) => {\n   const iframeLikes: ExcalidrawIframeElement[] = [];\n-  // The parameter elements comes ordered from lower z-index to higher.\n-  // We want to preserve that order on the returned array.\n-  // Exception being embeddables which should be on top of everything else in\n-  // terms of hit testing.\n-  const elsAtPos = elements.filter((element) => {\n-    const hit = !element.isDeleted && isAtPositionFn(element);\n-    if (hit) {\n-      if (isIframeElement(element)) {\n-        iframeLikes.push(element);\n-        return false;\n-      }\n-      return true;\n+  const elementsAtPosition: NonDeletedExcalidrawElement[] = [];\n+  // We need to to hit testing from front (end of the array) to back (beginning of the array)\n+  // because array is ordered from lower z-index to highest and we want element z-index\n+  // with higher z-index\n+  for (let index = elements.length - 1; index >= 0; --index) {\n+    const element = elements[index];\n+    if (element.isDeleted) {\n+      continue;\n     }\n-    return false;\n-  });\n-  return elsAtPos.concat(iframeLikes);\n+    if (isIframeElement(element)) {\n+      iframeLikes.push(element);\n+      continue;\n+    }\n+    if (isAtPositionFn(element)) {\n+      elementsAtPosition.push(element);\n+    }\n+  }\n+\n+  return elementsAtPosition.concat(iframeLikes);\n };\ndiff --git a/packages/excalidraw/utils.ts b/packages/excalidraw/utils.ts\nindex e30c67ff6898..e4431ddd1f8f 100644\n--- a/packages/excalidraw/utils.ts\n+++ b/packages/excalidraw/utils.ts\n@@ -9,7 +9,11 @@ import {\n   isDarwin,\n   WINDOWS_EMOJI_FALLBACK_FONT,\n } from \"./constants\";\n-import type { FontFamilyValues, FontString } from \"./element/types\";\n+import type {\n+  ExcalidrawBindableElement,\n+  FontFamilyValues,\n+  FontString,\n+} from \"./element/types\";\n import type {\n   ActiveTool,\n   AppState,\n@@ -543,6 +547,9 @@ export const isTransparent = (color: string) => {\n   );\n };\n \n+export const isBindingFallthroughEnabled = (el: ExcalidrawBindableElement) =>\n+  el.fillStyle !== \"solid\" || isTransparent(el.backgroundColor);\n+\n export type ResolvablePromise<T> = Promise<T> & {\n   resolve: [T] extends [undefined]\n     ? (value?: MaybePromise<Awaited<T>>) => void\n",
			"diffSize": 14524,
			"diffTruncated": false,
			"filterResult": {
				"included": true
			}
		},
		{
			"sha": "86c67bd37fe182f70ad994dd7acb6ee2dc128c39",
			"message": "fix: library item checkbox style regression (#9080)",
			"user": "dwelle",
			"timestamp": "2025-02-01T11:27:41Z",
			"author": {
				"name": "David Luzar",
				"email": "5153846+dwelle@users.noreply.github.com",
				"username": "dwelle"
			},
			"files": {
				"added": [],
				"modified": ["packages/excalidraw/components/IconPicker.tsx"],
				"removed": []
			},
			"diff": "diff --git a/packages/excalidraw/components/IconPicker.tsx b/packages/excalidraw/components/IconPicker.tsx\nindex 830712bbfe75..1a96a175d3c4 100644\n--- a/packages/excalidraw/components/IconPicker.tsx\n+++ b/packages/excalidraw/components/IconPicker.tsx\n@@ -5,7 +5,7 @@ import { getLanguage, t } from \"../i18n\";\n import clsx from \"clsx\";\n import Collapsible from \"./Stats/Collapsible\";\n import { atom, useAtom } from \"../editor-jotai\";\n-import { useDevice } from \"..\";\n+import { useDevice } from \"./App\";\n \n import \"./IconPicker.scss\";\n \n",
			"diffSize": 535,
			"diffTruncated": false,
			"filterResult": {
				"included": true
			}
		}
	]
}
